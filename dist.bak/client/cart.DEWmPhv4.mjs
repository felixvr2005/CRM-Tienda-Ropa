let f=[],p=0;const h=4;let v=0,g=e=>{let r=[],t={get(){return t.lc||t.listen(()=>{})(),t.value},lc:0,listen(n){return t.lc=r.push(n),()=>{for(let s=p+h;s<f.length;)f[s]===n?f.splice(s,h):s+=h;let o=r.indexOf(n);~o&&(r.splice(o,1),--t.lc||t.off())}},notify(n,o){v++;let s=!f.length;for(let a of r)f.push(a,t.value,n,o);if(s){for(p=0;p<f.length;p+=h)f[p](f[p+1],f[p+2],f[p+3]);f.length=0}},off(){},set(n){let o=t.value;o!==n&&(t.value=n,t.notify(o))},subscribe(n){let o=t.listen(n);return n(t.value),o},value:e};return t};const C=5,m=6,y=10;let k=(e,r,t,n)=>(e.events=e.events||{},e.events[t+y]||(e.events[t+y]=n(o=>{e.events[t].reduceRight((s,a)=>(a(s),s),{shared:{},...o})})),e.events[t]=e.events[t]||[],e.events[t].push(r),()=>{let o=e.events[t],s=o.indexOf(r);o.splice(s,1),o.length||(delete e.events[t],e.events[t+y](),delete e.events[t+y])}),q=1e3,N=(e,r)=>k(e,n=>{let o=r(n);o&&e.events[m].push(o)},C,n=>{let o=e.listen;e.listen=(...a)=>(!e.lc&&!e.active&&(e.active=!0,n()),o(...a));let s=e.off;return e.events[m]=[],e.off=()=>{s(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let a of e.events[m])a();e.events[m]=[]}},q)},()=>{e.listen=o,e.off=s}}),M=(e,r,t)=>{Array.isArray(e)||(e=[e]);let n,o,s=()=>{if(o===v)return;o=v;let d=e.map(l=>l.get());if(!n||d.some((l,T)=>l!==n[T])){n=d;let l=r(...d);l&&l.then&&l.t?l.then(T=>{n===d&&a.set(T)}):(a.set(l),o=v)}},a=g(void 0),u=a.get;a.get=()=>(s(),u());let i=s;return N(a,()=>{let d=e.map(l=>l.listen(i));return s(),()=>{for(let l of d)l()}}),a},S=(e,r)=>M(e,r);const c=g([]),D=g(!1),w=g(!1),U=g(null),P=S(c,e=>e.reduce((r,t)=>r+t.quantity,0)),b=S(c,e=>e.reduce((r,t)=>r+t.price*t.quantity,0));S(c,e=>e.reduce((r,t)=>r+(t.originalPrice-t.price)*t.quantity,0));const L=S(c,e=>e.length>0);function R(){if(typeof window>"u")return"";let e=localStorage.getItem("fashionstore_guest_session");return e||(e="guest_"+crypto.randomUUID(),localStorage.setItem("fashionstore_guest_session",e)),e}function Q(){if(!(typeof window>"u"))try{const e=localStorage.getItem("fashionstore_cart"),r=localStorage.getItem("fashionstore_cart_expires");e&&r&&(new Date(r)>new Date?(c.set(JSON.parse(e)),O()):I())}catch(e){console.error("Error loading cart:",e)}}function _(e){if(!(typeof window>"u"))try{localStorage.setItem("fashionstore_cart",JSON.stringify(e));const r=new Date;r.setMinutes(r.getMinutes()+15),localStorage.setItem("fashionstore_cart_expires",r.toISOString())}catch(r){console.error("Error saving cart:",r)}}async function A(e,r=1){const t=c.get(),n=t.findIndex(a=>a.variantId===e.variantId);let o,s=r;if(n>=0){const a=t[n],u=Math.min(a.quantity+r,a.maxStock);s=u-a.quantity,o=t.map((i,d)=>d===n?{...i,quantity:u}:i)}else s=Math.min(r,e.maxStock),o=[...t,{...e,quantity:s}];if(s>0)try{const a=await fetch("/api/stock/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({variantId:e.variantId,quantity:s})});if(!a.ok){const u=await a.json();console.error("Error reservando stock:",u),alert(u.error||"Error al reservar el producto");return}}catch(a){console.error("Error en reserva de stock:",a)}c.set(o),_(o),O(),D.set(!0)}async function F(e,r){const t=c.get(),n=t.find(i=>i.variantId===e);if(!n)return;if(r<=0){await J(e);return}const o=n.quantity,s=Math.min(r,n.maxStock),a=s-o;if(a>0)try{const i=await fetch("/api/stock/reserve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({variantId:e,quantity:a})});if(!i.ok){const d=await i.json();alert(d.error||"Stock insuficiente");return}}catch(i){console.error("Error reservando stock:",i);return}else if(a<0)try{await fetch("/api/stock/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({variantId:e,quantity:Math.abs(a)})})}catch(i){console.error("Error liberando stock:",i)}const u=t.map(i=>i.variantId===e?{...i,quantity:s}:i);c.set(u),_(u)}async function J(e){const r=c.get(),t=r.find(o=>o.variantId===e);if(t)try{await fetch("/api/stock/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({variantId:e,quantity:t.quantity})})}catch(o){console.error("Error liberando stock:",o)}const n=r.filter(o=>o.variantId!==e);c.set(n),_(n)}async function I(e=!0){const r=c.get();if(e&&r.length>0)for(const t of r)try{await fetch("/api/stock/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({variantId:t.variantId,quantity:t.quantity})})}catch(n){console.error("Error liberando stock:",n)}c.set([]),typeof window<"u"&&(localStorage.removeItem("fashionstore_cart"),localStorage.removeItem("fashionstore_cart_expires"),window.dispatchEvent(new CustomEvent("cart:cleared")))}let x=null;function O(){if(typeof window>"u")return;x&&clearTimeout(x);const e=localStorage.getItem("fashionstore_cart_expires");if(!e)return;const r=new Date(e),t=new Date,n=r.getTime()-t.getTime();if(n<=0){I(!0);return}x=setTimeout(async()=>{await I(!0),alert("Tu carrito ha expirado despuÃ©s de 15 minutos. Los productos han sido devueltos al stock.")},n)}function G(){if(typeof window>"u")return 0;const e=localStorage.getItem("fashionstore_cart_expires");if(!e)return 0;const r=new Date(e),t=new Date,n=r.getTime()-t.getTime();return Math.max(0,Math.floor(n/1e3))}async function E(e){w.set(!0);try{const r=await fetch(`/api/cart?customerId=${e}`);if(r.ok){const{items:t}=await r.json();c.set(t),U.set(e)}}catch(r){console.error("Error loading cart from server:",r)}finally{w.set(!1)}}async function V(e){const r=c.get(),t=R();if(r.length===0){await E(e);return}w.set(!0);try{await fetch("/api/cart/merge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:t,customerId:e,items:r})}),localStorage.removeItem("fashionstore_cart"),localStorage.removeItem("fashionstore_cart_expires"),localStorage.removeItem("fashionstore_guest_session"),await E(e)}catch(n){console.error("Error merging cart:",n)}finally{w.set(!1)}}export{c as $,A as a,P as b,I as c,b as d,L as e,G as g,Q as i,V as m,J as r,O as s,F as u};
