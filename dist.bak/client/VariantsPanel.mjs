import{j as s}from"./jsx-runtime.D_zvdyIk.mjs";import{r as g}from"./index.Da02gyCa.mjs";function T({productId:M,productName:w,productSlug:C,variants:p}){const[x,h]=g.useState(p),[u,c]=g.useState({}),[f,y]=g.useState({}),[b,F]=g.useState(p.length>0?p[0].id:null),[_,N]=g.useState(!1),L=g.useRef({});g.useEffect(()=>{if(window.cloudinary){N(!0);return}const e=document.createElement("script");e.src="https://upload-widget.cloudinary.com/global/all.js",e.async=!0,e.onload=()=>N(!0),document.body.appendChild(e)},[]);const a=(e,r,o)=>{y(l=>({...l,[e]:{type:r,text:o}})),setTimeout(()=>{y(l=>{const t={...l};return delete t[e],t})},2500)},k=async(e,r)=>{try{c(i=>({...i,[e]:!0}));const o=r||"Personalizado",l=r.startsWith("#")?r:"#000000";if(!(await fetch(`/api/admin/variants/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({color:o,color_hex:l})})).ok)throw new Error("Error al guardar color");h(i=>i.map(d=>d.id===e?{...d,color:o,color_hex:l}:d)),a(e,"success","Color actualizado ✓")}catch(o){a(e,"error","Error al guardar color"),console.error(o)}finally{c(o=>({...o,[e]:!1}))}},j=async e=>{if(!_||!window.cloudinary){a(e,"error","El widget no está listo");return}window.cloudinary.createUploadWidget({cloudName:"dwyksbbk0",uploadPreset:"tienda_productos",folder:"productos",sources:["local","url","camera"],multiple:!0,maxFiles:5,maxFileSize:1e7,clientAllowedFormats:["jpg","jpeg","png","webp"],cropping:!1,styles:{palette:{window:"#FFFFFF",windowBorder:"#CBD5E1",tabIcon:"#3B82F6",menuIcons:"#64748B",textDark:"#1E293B",textLight:"#FFFFFF",link:"#3B82F6",action:"#F97316",inactiveTabIcon:"#94A3B8",error:"#EF4444",inProgress:"#3B82F6",complete:"#22C55E",sourceBg:"#F1F5F9"}}},async(o,l)=>{if(console.log("Widget callback:",{error:o,resultEvent:l?.event,hasInfo:!!l?.info}),o){console.error("Cloudinary error:",o),a(e,"error",`Error: ${o.message}`);return}if(l&&l.event==="success"){console.log("Image uploaded successfully:",l.info);try{c(n=>({...n,[e]:!0}));const t=l.info.secure_url,i=l.info.original_filename||l.info.public_id;console.log("Saving to DB:",{variant_id:e,image_url:t});const d=await fetch("/api/admin/variant-images",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({variant_id:e,images:[{image_url:t,alt_text:i,is_primary:!1,sort_order:x.find(n=>n.id===e)?.images?.length||0}]})});if(console.log("API response status:",d.status),!d.ok){const n=await d.text();console.error("API error response:",n);try{const m=JSON.parse(n);throw new Error(m.error||"Error al guardar imágenes")}catch{throw new Error("Error al guardar imágenes: "+n)}}const E=await d.json();console.log("Images saved:",E.images?.length),h(n=>n.map(m=>m.id===e?{...m,images:[...m.images||[],...E.images||[]]}:m)),a(e,"success","Imagen agregada ✓")}catch(t){a(e,"error",`Error al guardar: ${t instanceof Error?t.message:"desconocido"}`),console.error("Save error:",t)}finally{c(t=>({...t,[e]:!1}))}}}).open()},S=(e,r)=>{const o=r.currentTarget.files;o&&o.length>0&&j(e)},B=async(e,r)=>{try{c(l=>({...l,[e]:!0}));const o=await fetch(`/api/admin/variant-images/${r}`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include"});if(!o.ok){const l=await o.json();throw new Error(l.error||"Error al eliminar imagen")}h(l=>l.map(t=>t.id===e?{...t,images:t.images?.filter(i=>i.id!==r)||[]}:t)),a(e,"success","Imagen eliminada ✓")}catch(o){a(e,"error","Error al eliminar imagen"),console.error("Delete error:",o)}finally{c(o=>({...o,[e]:!1}))}},z=async(e,r)=>{try{c(l=>({...l,[e]:!0}));const o=await fetch(`/api/admin/variant-images/${r}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({variant_id:e,is_primary:!0})});if(!o.ok){const l=await o.json();throw new Error(l.error||"Error al actualizar imagen principal")}h(l=>l.map(t=>t.id===e?{...t,images:t.images?.map(i=>({...i,is_primary:i.id===r}))||[]}:t)),a(e,"success","Imagen principal actualizada ✓")}catch(o){a(e,"error","Error al actualizar imagen"),console.error("Set primary error:",o)}finally{c(o=>({...o,[e]:!1}))}};return s.jsxs("div",{className:"w-full",children:[s.jsxs("div",{className:"mb-8",children:[s.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:w}),s.jsx("p",{className:"text-slate-500 mt-2",children:"Personaliza colores e imágenes de cada variante"})]}),s.jsx("div",{className:"space-y-4",children:x.length===0?s.jsx("div",{className:"text-center py-12 bg-slate-50 rounded-lg",children:s.jsx("p",{className:"text-slate-500",children:"No hay variantes disponibles"})}):x.map(e=>s.jsxs("div",{className:"bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow",children:[s.jsxs("button",{onClick:()=>F(b===e.id?null:e.id),className:"w-full px-6 py-4 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white hover:from-slate-100 hover:to-slate-50 transition-colors",children:[s.jsxs("div",{className:"flex items-center gap-4 flex-1",children:[s.jsx("div",{className:"w-12 h-12 rounded-full border-2 border-slate-200 shadow-md",style:{backgroundColor:e.color_hex||"#e2e8f0"}}),s.jsxs("div",{className:"text-left",children:[s.jsx("h3",{className:"font-semibold text-slate-900",children:e.color||"Sin color"}),s.jsxs("p",{className:"text-sm text-slate-500",children:[e.size," • ",e.images?.length||0," imagen(es) • Stock: ",e.stock]})]})]}),s.jsx("svg",{className:`w-5 h-5 text-slate-600 transition-transform ${b===e.id?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 14l-7 7m0 0l-7-7m7 7V3"})})]}),b===e.id&&s.jsxs("div",{className:"border-t border-slate-200 px-6 py-6 bg-white space-y-6",children:[f[e.id]&&s.jsx("div",{className:`p-4 rounded-lg text-sm font-medium ${f[e.id].type==="success"?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:f[e.id].text}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-semibold text-slate-900 mb-3",children:"Color"}),s.jsxs("div",{className:"flex gap-3 items-end",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("label",{className:"block text-xs text-slate-600 mb-2",children:"Selector RGB"}),s.jsx("input",{type:"color",value:e.color_hex||"#000000",onChange:r=>k(e.id,r.target.value),disabled:u[e.id],className:"w-full h-12 border border-slate-300 rounded-lg cursor-pointer"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("label",{className:"block text-xs text-slate-600 mb-2",children:"Nombre"}),s.jsx("input",{type:"text",value:e.color||"",onChange:r=>{h(o=>o.map(l=>l.id===e.id?{...l,color:r.target.value}:l))},onBlur:r=>{r.target.value!==e.color&&k(e.id,e.color_hex||"#000000")},placeholder:"Ej: Azul Marino",disabled:u[e.id],className:"w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"})]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-semibold text-slate-900 mb-3",children:"Imágenes"}),s.jsxs("div",{onDragOver:r=>r.preventDefault(),onDrop:r=>{r.preventDefault(),j(e.id)},onClick:()=>j(e.id),className:"border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer hover:border-slate-400 hover:bg-slate-50 transition-colors",children:[s.jsx("svg",{className:"w-10 h-10 text-slate-400 mx-auto mb-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"})}),s.jsx("p",{className:"text-sm font-medium text-slate-700",children:"Arrastra imágenes aquí o haz clic para seleccionar"}),s.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"PNG, JPG o GIF • Máx 5MB"}),s.jsx("input",{ref:r=>{r&&(L.current[e.id]=r)},type:"file",multiple:!0,accept:"image/*",onChange:r=>S(e.id,r),className:"hidden",disabled:u[e.id]})]}),e.images&&e.images.length>0&&s.jsxs("div",{className:"mt-4",children:[s.jsxs("p",{className:"text-xs text-slate-600 mb-3",children:[e.images.length," imagen(es) cargada(s)"]}),s.jsx("div",{className:"grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3",children:e.images.map(r=>s.jsxs("div",{className:"relative group rounded-lg overflow-hidden bg-slate-100 aspect-square",children:[s.jsx("img",{src:r.image_url,alt:r.alt_text,className:"w-full h-full object-cover"}),s.jsxs("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2",children:[s.jsx("button",{onClick:()=>z(e.id,r.id),title:"Marcar como imagen principal",disabled:u[e.id],className:"p-2 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition-colors",children:s.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:s.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})})}),s.jsx("button",{onClick:()=>B(e.id,r.id),title:"Eliminar imagen",disabled:u[e.id],className:"p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors",children:s.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:s.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})]}),r.is_primary&&s.jsx("div",{className:"absolute top-1 left-1 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded",children:"Principal"})]},r.id))})]})]}),s.jsx("div",{className:"flex gap-3 pt-4 border-t border-slate-200",children:s.jsxs("a",{href:`/productos/${C||w.toLowerCase().replace(/\s+/g,"-")}?color=${encodeURIComponent(e.color||"")}`,target:"_blank",rel:"noopener noreferrer",className:"flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium",children:[s.jsxs("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]}),"Ver en tienda"]})})]})]},e.id))})]})}export{T as default};
