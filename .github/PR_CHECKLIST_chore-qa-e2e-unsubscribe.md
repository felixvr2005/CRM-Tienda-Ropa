# PR / QA Checklist — chore/qa-e2e-unsubscribe

Resumen rápido
- Alcance: idempotencia en webhooks Stripe, flujo newsletter (subscribe + unsubscribe), cálculos de envío (checkout → order → email), ordenación de tallas (zapato), tests unitarios y E2E añadidos, CI actualizado.

Before merging (must-pass)
1. ✅ Build: `npm run build` — no warnings críticos.
2. ✅ Unit tests: `npm test` — **todas** deben pasar.
3. ✅ CI: GitHub Actions (build → unit → preview → E2E) — green on branch.
4. ✅ Playwright E2E (staging): run with real Stripe test keys (see below).

Staging preconditions (required to validate end-to-end)
- Secrets (GitHub / staging env):
  - `STRIPE_SECRET_KEY` (test key)
  - `STRIPE_WEBHOOK_SECRET` (test webhook secret)
  - `SUPABASE_URL` / `SUPABASE_ANON_KEY` / `SUPABASE_SERVICE_KEY`
  - `GMAIL_USER`, `GMAIL_APP_PASSWORD` (or SendGrid API key)
  - Optional: `SENTRY_DSN`

Staging validation steps (manual + automated)
1. Deploy branch to staging (or run workflow `build-and-test` on a staging runner).
2. Run Playwright E2E in CI against the preview (automated).
3. Manual scenarios to run in staging (must do):
   - Create account → add 3 different items (including a shoe variant) → confirm size selector shows EU sizes ordered.
   - Checkout standard shipping (subtotal < free threshold) → verify Stripe Checkout shows shipping line and final paid amount.
   - Replay the same Stripe webhook payload twice → confirm only one order created (idempotency).
   - Purchase above free-shipping threshold → shipping cost = 0 in order and confirmation email.
   - Subscribe to newsletter → receive welcome email with discount → click unsubscribe link → subscriber marked unsubscribed.
4. Email checks: confirm `email-customer` and `email-admin` show `shipping_cost` and `total_amount` correctly.
5. Admin checks: open order in admin dashboard → verify `shipping_cost`, `total_amount` and order items present.

Local developer reproducibility (quick)
- To run unit/E2E locally:
  1. Sync lockfile: `npm install` (if package-lock.json is out of sync, update & commit it).
  2. Install Playwright browsers: `npx playwright install --with-deps`.
  3. Start preview: `npm run build && npm run preview -- --port 5173`.
  4. Run E2E locally (mocked): `npx playwright test -g "(newsletter|checkout)"`.

Merge criteria (required)
- All CI checks green on branch.
- Staging smoke tests (above) manually verified by QA or owner.
- No new console.error or uncaught runtime warnings in staging logs for checkout/webhook endpoints.

Rollback plan
- If webhook/order duplication or payment reconciliation issues observed: revert the PR and run `api/admin/fix-order-totals.ts` + audit webhook logs.

Notes / follow-ups (post-merge)
- Add Sentry DSN in staging & enable alerting for `webhooks/stripe` failures.
- Optionally: commit `package-lock.json` update to allow reproducible local E2E runs.

PR: https://github.com/felixvr2005/CRM-Tienda-Ropa/pull/new/chore/qa-e2e-unsubscribe

---
Generated by automation — attach test evidence (CI links / screenshots) before merging.
