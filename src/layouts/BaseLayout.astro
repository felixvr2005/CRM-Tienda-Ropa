---
/**
 * BaseLayout - Shell HTML común
 * Incluye meta tags, fuentes y estilos globales
 */
interface Props {
  title: string;
  description?: string;
  image?: string;
}

const { 
  title, 
  description = 'Moda premium masculina. Descubre las últimas tendencias en ropa y accesorios.',
  image = '/images/og-image.jpg'
} = Astro.props;

// Manejar URL canónica de forma segura
const siteUrl = Astro.site || new URL('http://localhost:4321');
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
---

<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="generator" content={Astro.generator} />
  
  <!-- SEO -->
  <title>{title} | FASHION STORE</title>
  <meta name="description" content={description} />
  <link rel="canonical" href={canonicalURL} />
  
  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={image} />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={image} />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body class="font-sans text-primary-900 antialiased">
  <slot />
</body>
</html>

<script>
  // Inicializar manejo global de CSRF para formularios POST
  document.addEventListener('submit', async (e) => {
    const form = e.target as HTMLFormElement;
    
    // Interceptar formularios POST que NO sean a APIs
    if (form.method.toUpperCase() === 'POST' && !form.action.includes('/api/')) {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data: Record<string, any> = {};
      
      // Convertir FormData a objeto
      for (const [key, value] of formData.entries()) {
        data[key] = value;
      }
      
      console.log('[CSRF Handler] Intercepting POST to:', form.action || window.location.pathname);
      
      try {
        // Enviar como JSON con headers para evitar CSRF
        const response = await fetch(form.action || window.location.pathname, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          // Recargar o redirigir
          const redirectUrl = (form as any).dataset.redirect;
          if (redirectUrl) {
            window.location.href = redirectUrl;
          } else {
            window.location.reload();
          }
        } else {
          const errorText = await response.text();
          console.error('[CSRF Handler] Error response:', response.status, errorText);
          alert('Error: ' + (response.statusText || 'Error al procesar'));
        }
      } catch (error) {
        console.error('[CSRF Handler] Error:', error);
        alert('Error de conexión: ' + error);
      }
    }
  }, true);
</script>

<style is:global>
  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f5f5f5;
  }
  ::-webkit-scrollbar-thumb {
    background: #d4d4d4;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #a3a3a3;
  }
  
  /* Selection */
  ::selection {
    background: #000;
    color: #fff;
  }
  
  /* Focus outline */
  :focus-visible {
    outline: 2px solid #000;
    outline-offset: 2px;
  }
</style>
