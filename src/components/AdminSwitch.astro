---
/**
 * AdminSwitch - Bot√≥n para navegar entre tienda y admin
 * Se muestra si el usuario es admin logueado
 */
import { supabase, supabaseAdmin } from '@lib/supabase';

interface Props {
  variant?: 'header' | 'sidebar';
  isAdminPage?: boolean;
}

const { variant = 'header', isAdminPage = false } = Astro.props;

// Verificar si el usuario actual es admin
let isAdmin = false;
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (accessToken) {
  try {
    const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);
    
    if (user && !authError) {
      try {
        const { data: adminUser, error: adminError } = await supabaseAdmin
          .from('admin_users')
          .select('id, is_active')
          .eq('auth_user_id', user.id)
          .eq('is_active', true)
          .single();
        
        if (adminUser && !adminError) {
          isAdmin = true;
        }
      } catch (e) {
        // Error querying admin_users
      }
    }
  } catch (error) {
    // Error getting user
  }
}
---

{isAdmin && variant === 'header' && (
  <a 
    href={isAdminPage ? '/' : '/admin'} 
    class="hidden sm:flex items-center gap-2 px-3 py-2 text-xs tracking-widest uppercase font-medium rounded-full transition-all"
    class:list={{
      'bg-primary-900 text-white hover:bg-primary-800': isAdminPage,
      'bg-primary-100 text-primary-900 hover:bg-primary-200': !isAdminPage
    }}
    title={isAdminPage ? 'Ir a la tienda' : 'Ir al panel de admin'}
  >
    {isAdminPage ? (
      <>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l-4-4m0 0L8 8m4-4v12" />
        </svg>
        <span>Tienda</span>
      </>
    ) : (
      <>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
        <span>Admin</span>
      </>
    )}
  </a>
)}

{isAdmin && variant === 'sidebar' && !isAdminPage && (
  <a 
    href="/admin" 
    class="flex items-center gap-3 w-full px-4 py-3 mt-2 text-sm text-primary-400 hover:text-white hover:bg-primary-800 rounded-lg transition-colors"
    title="Ir al panel de admin"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
    </svg>
    Panel de Admin
  </a>
)}
