---
/**
 * Admin - Configuración del Sistema
 * Toggle de ofertas flash y otras configuraciones
 */
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabaseAdmin } from '@lib/supabase';

export const prerender = false;

// Manejar actualización de configuración
let successMessage = '';
let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    // Aceptar tanto FormData como JSON
    let data: Record<string, any> = {};
    const contentType = Astro.request.headers.get('content-type');
    
    if (contentType?.includes('application/json')) {
      data = await Astro.request.json();
    } else {
      const formData = await Astro.request.formData();
      for (const [key, value] of formData.entries()) {
        data[key] = value;
      }
    }

    const action = data.action;

    if (action === 'updateOfertasFlash') {
      const ofertasActivas = data.ofertas_activas === 'on' || data.ofertas_activas === true;
      
      // Actualizar o insertar configuración
      const { error } = await supabaseAdmin
        .from('configuracion')
        .upsert({
          clave: 'ofertas_activas',
          valor: ofertasActivas ? 'true' : 'false',
          tipo: 'boolean',
          descripcion: 'Activa/desactiva la sección de ofertas flash en la home',
          categoria: 'ofertas'
        }, {
          onConflict: 'clave'
        });

      if (error) throw error;
      successMessage = ofertasActivas 
        ? 'Ofertas Flash ACTIVADAS' 
        : 'Ofertas Flash DESACTIVADAS';
    }

    if (action === 'updateGeneral') {
      const siteName = data.site_name as string;
      const siteDescription = data.site_description as string;
      const contactEmail = data.contact_email as string;
      const contactPhone = data.contact_phone as string;

      // Actualizar configuraciones
      const configs = [
        { clave: 'site_name', valor: siteName, tipo: 'string', descripcion: 'Nombre del sitio', categoria: 'general' },
        { clave: 'site_description', valor: siteDescription, tipo: 'string', descripcion: 'Descripción del sitio', categoria: 'general' },
        { clave: 'contact_email', valor: contactEmail, tipo: 'string', descripcion: 'Email de contacto', categoria: 'general' },
        { clave: 'contact_phone', valor: contactPhone, tipo: 'string', descripcion: 'Teléfono de contacto', categoria: 'general' },
      ];

      for (const config of configs) {
        const { error } = await supabaseAdmin
          .from('configuracion')
          .upsert(config, { onConflict: 'clave' });
        if (error) throw error;
      }

      successMessage = 'Configuración general actualizada';
    }

    if (action === 'updateShipping') {
      const freeShippingThreshold = data.free_shipping_threshold as string;
      const standardShippingCost = data.standard_shipping_cost as string;
      const expressShippingCost = data.express_shipping_cost as string;

      const configs = [
        { clave: 'free_shipping_threshold', valor: freeShippingThreshold, tipo: 'number', descripcion: 'Umbral para envío gratis (€)', categoria: 'shipping' },
        { clave: 'standard_shipping_cost', valor: standardShippingCost, tipo: 'number', descripcion: 'Coste envío estándar (€)', categoria: 'shipping' },
        { clave: 'express_shipping_cost', valor: expressShippingCost, tipo: 'number', descripcion: 'Coste envío express (€)', categoria: 'shipping' },
      ];

      for (const config of configs) {
        const { error } = await supabaseAdmin
          .from('configuracion')
          .upsert(config, { onConflict: 'clave' });
        if (error) throw error;
      }

      successMessage = 'Configuración de envío actualizada';
    }
  } catch (err: any) {
    console.error('Error updating config:', err);
    errorMessage = err.message || 'Error al actualizar la configuración';
  }
}

// Obtener todas las configuraciones (usar supabaseAdmin para asegurar lectura completa)
const { data: configs, error: configsError } = await supabaseAdmin
  .from('configuracion')
  .select('*')
  .order('categoria');

if (configsError) {
  console.error('Error reading configs:', configsError);
}

// Helper para obtener valor de configuración
function getConfig(key: string, defaultValue: string = ''): string {
  const config = configs?.find(c => c.clave === key);
  return config?.valor || defaultValue;
}

const ofertasActivas = getConfig('ofertas_activas', 'false') === 'true';
---

<AdminLayout title="Configuración">
  <div class="max-w-4xl mx-auto space-y-8">
    <div>
      <h1 class="text-2xl font-display">Configuración</h1>
      <p class="text-primary-500">Gestiona la configuración del sistema</p>
    </div>

    {successMessage && (
      <div class="p-4 bg-green-50 border border-green-200 text-green-800 flex items-center gap-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        {successMessage}
      </div>
    )}

    {errorMessage && (
      <div class="p-4 bg-red-50 border border-red-200 text-red-800 flex items-center gap-3">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        {errorMessage}
      </div>
    )}

    <!-- Ofertas Flash Toggle -->
    <div class="bg-white border border-primary-200 p-6">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-lg font-medium flex items-center gap-2">
            <span class="text-2xl">⚡</span>
            Ofertas Flash
          </h2>
          <p class="text-sm text-primary-500 mt-1">
            Activa o desactiva la sección de ofertas flash en la página principal
          </p>
        </div>
        
        <form method="POST" id="ofertasForm">
          <input type="hidden" name="action" value="updateOfertasFlash" />
          <label class="relative inline-flex items-center cursor-pointer">
            <input 
              type="checkbox" 
              name="ofertas_activas"
              checked={ofertasActivas}
              class="sr-only peer"
              onchange="this.form.submit()"
            />
            <div class="w-14 h-7 bg-primary-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-primary-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
            <span class="ml-3 text-sm font-medium text-primary-700">
              {ofertasActivas ? 'Activado' : 'Desactivado'}
            </span>
          </label>
        </form>
      </div>

      <div class={`mt-4 p-4 rounded-lg ${ofertasActivas ? 'bg-green-50 border border-green-200' : 'bg-primary-50 border border-primary-200'}`}>
        <div class="flex items-center gap-2">
          <span class={`w-3 h-3 rounded-full ${ofertasActivas ? 'bg-green-500 animate-pulse' : 'bg-primary-300'}`}></span>
          <span class="text-sm font-medium">
            {ofertasActivas 
              ? 'Las ofertas flash se están mostrando en la página principal'
              : 'Las ofertas flash están ocultas en la página principal'
            }
          </span>
        </div>
      </div>
    </div>

    <!-- Configuración General -->
    <div class="bg-white border border-primary-200 p-6">
      <h2 class="text-lg font-medium mb-4">Configuración General</h2>
      
      <form method="POST" class="space-y-4">
        <input type="hidden" name="action" value="updateGeneral" />
        
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Nombre del sitio
            </label>
            <input 
              type="text"
              name="site_name"
              value={getConfig('site_name', 'FashionStore')}
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Email de contacto
            </label>
            <input 
              type="email"
              name="contact_email"
              value={getConfig('contact_email', 'hola@fashionstore.com')}
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Teléfono de contacto
            </label>
            <input 
              type="tel"
              name="contact_phone"
              value={getConfig('contact_phone', '+34 900 123 456')}
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            />
          </div>
          
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Descripción del sitio
            </label>
            <textarea 
              name="site_description"
              rows="2"
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            >{getConfig('site_description', 'Tu tienda de moda masculina premium')}</textarea>
          </div>
        </div>

        <button 
          type="submit"
          class="bg-primary-900 text-white px-6 py-2 text-sm hover:bg-primary-800 transition-colors"
        >
          Guardar cambios
        </button>
      </form>
    </div>

    <!-- Configuración de Envío -->
    <div class="bg-white border border-primary-200 p-6">
      <h2 class="text-lg font-medium mb-4">Configuración de Envío</h2>
      
      <form method="POST" class="space-y-4">
        <input type="hidden" name="action" value="updateShipping" />
        
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Envío gratis desde (€)
            </label>
            <input 
              type="number"
              name="free_shipping_threshold"
              step="0.01"
              min="0"
              value={getConfig('free_shipping_threshold', '100')}
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            />
            <p class="text-xs text-primary-500 mt-1">0 = siempre gratis</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Envío estándar (€)
            </label>
            <input 
              type="number"
              name="standard_shipping_cost"
              step="0.01"
              min="0"
              value={getConfig('standard_shipping_cost', '4.95')}
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-primary-700 mb-1">
              Envío express (€)
            </label>
            <input 
              type="number"
              name="express_shipping_cost"
              step="0.01"
              min="0"
              value={getConfig('express_shipping_cost', '9.95')}
              class="w-full border border-primary-300 px-4 py-2 focus:outline-none focus:border-primary-900"
            />
          </div>
        </div>

        <button 
          type="submit"
          class="bg-primary-900 text-white px-6 py-2 text-sm hover:bg-primary-800 transition-colors"
        >
          Guardar cambios
        </button>
      </form>
    </div>

    <!-- Sincronización de precios Stripe -->
    <div class="bg-white border border-primary-200 p-6">
      <h2 class="text-lg font-medium mb-2">Sincronización de Stripe</h2>
      <p class="text-sm text-primary-500 mb-4">
        Sincroniza los precios de los productos con Stripe. Si los precios no coinciden, se actualizarán automáticamente.
      </p>
      
      <button 
        id="syncStripeBtn"
        type="button"
        class="bg-indigo-600 text-white px-6 py-2 text-sm hover:bg-indigo-700 transition-colors disabled:opacity-50"
      >
        Sincronizar precios con Stripe
      </button>

      <div id="syncResult" class="mt-4 hidden p-4 rounded border"></div>
    </div>

    <!-- Estado de configuraciones -->
    <div class="bg-white border border-primary-200 p-6">
      <h2 class="text-lg font-medium mb-4">Todas las configuraciones</h2>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-primary-200">
              <th class="text-left py-2 px-4 font-medium">Clave</th>
              <th class="text-left py-2 px-4 font-medium">Valor</th>
              <th class="text-left py-2 px-4 font-medium">Tipo</th>
              <th class="text-left py-2 px-4 font-medium">Categoría</th>
            </tr>
          </thead>
          <tbody>
            {configs && configs.length > 0 ? (
              configs.map((config: any) => (
                <tr class="border-b border-primary-100 hover:bg-primary-50">
                  <td class="py-2 px-4 font-mono text-xs">{config.clave}</td>
                  <td class="py-2 px-4">
                    {config.tipo === 'boolean' ? (
                      <span class={`px-2 py-0.5 rounded text-xs ${config.valor === 'true' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {config.valor === 'true' ? 'Sí' : 'No'}
                      </span>
                    ) : (
                      config.valor
                    )}
                  </td>
                  <td class="py-2 px-4 text-primary-500">{config.tipo}</td>
                  <td class="py-2 px-4 text-primary-500">{config.categoria}</td>
                </tr>
              ))
            ) : (
              <tr>
                <td colspan="4" class="py-8 text-center text-primary-500">
                  No hay configuraciones guardadas
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</AdminLayout>

<script is:inline>
  // Handler para sincronización de Stripe
  const syncBtn = document.getElementById('syncStripeBtn');
  const syncResult = document.getElementById('syncResult');

  if (syncBtn) {
    syncBtn.addEventListener('click', async () => {
      const originalText = syncBtn.textContent;
      syncBtn.disabled = true;
      syncBtn.textContent = 'Sincronizando...';
      
      if (syncResult) syncResult.className = 'mt-4 hidden p-4 rounded border';

      try {
        const response = await fetch('/api/admin/products/sync-stripe-prices', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          syncResult.innerHTML = `
            <div class="space-y-2">
              <p class="font-medium text-green-800">[OK] ${data.message}</p>
              <p class="text-sm text-green-700">Sincronizados: ${data.results.synced}/${data.results.total}</p>
              ${data.results.errors.length > 0 ? `
                <details class="mt-2">
                  <summary class="cursor-pointer text-sm font-medium text-yellow-700">Errores (${data.results.errors.length})</summary>
                  <ul class="mt-2 text-xs text-yellow-600 space-y-1">
                    ${data.results.errors.map(e => `<li>• ${e}</li>`).join('')}
                  </ul>
                </details>
              ` : ''}
              ${data.results.details.length > 0 ? `
                <details class="mt-2">
                  <summary class="cursor-pointer text-sm font-medium">Detalles (${data.results.details.length})</summary>
                  <div class="mt-2 text-xs space-y-1 max-h-64 overflow-y-auto">
                    ${data.results.details.map(d => `
                      <div class="p-1 bg-gray-50 rounded">
                        <strong>${d.product}</strong>
                        ${d.variant ? `<div class="text-gray-600">${d.variant}</div>` : ''}
                        ${d.price ? `<div class="text-green-600">${d.price}</div>` : ''}
                        ${d.oldPrice ? `<div class="text-red-600">${d.oldPrice}</div>` : ''}
                        ${d.newPrice ? `<div class="text-green-600">${d.newPrice}</div>` : ''}
                        <div class="text-gray-500">${d.status}</div>
                      </div>
                    `).join('')}
                  </div>
                </details>
              ` : ''}
            </div>
          `;
          syncResult.className = 'mt-4 p-4 rounded border bg-green-50 border-green-200';
        } else {
          syncResult.innerHTML = `
            <p class="font-medium text-red-800">[Error] ${data.error}</p>
          `;
          syncResult.className = 'mt-4 p-4 rounded border bg-red-50 border-red-200';
        }

        if (syncResult) syncResult.classList.remove('hidden');
      } catch (error: any) {
        syncResult.innerHTML = `<p class="font-medium text-red-800">[Error] ${error.message}</p>`;
        syncResult.className = 'mt-4 p-4 rounded border bg-red-50 border-red-200';
        if (syncResult) syncResult.classList.remove('hidden');
      } finally {
        syncBtn.disabled = false;
        syncBtn.textContent = originalText;
      }
    });
  }
</script>
