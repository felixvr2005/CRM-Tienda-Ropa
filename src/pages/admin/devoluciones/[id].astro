---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabaseAdmin } from '@lib/supabase';

export const prerender = false;

const { id } = Astro.params;

// Validar que el ID sea válido
if (!id || typeof id !== 'string') {
  return Astro.redirect('/admin/devoluciones');
}

let formattedReturn: any = null;

try {
  console.log('[Admin Devoluciones Detail] Obteniendo devolución:', id);
  
  // Query 1: Obtener la devolución principal (sin relaciones)
  const { data: returnRequest, error: queryError } = await supabaseAdmin
    .from('return_requests')
    .select('*')
    .eq('id', id)
    .single();

  console.log('[Admin Devoluciones Detail] Error query 1:', queryError?.message);
  console.log('[Admin Devoluciones Detail] Datos query 1:', returnRequest);

  if (queryError || !returnRequest) {
    console.error('[Admin Devoluciones Detail] Devolución no encontrada:', queryError?.message || 'No data');
    return Astro.redirect('/admin/devoluciones');
  }

  // Query 2: Obtener datos del pedido
  let orderData: any = null;
  if (returnRequest.order_id) {
    const { data: order, error: orderError } = await supabaseAdmin
      .from('orders')
      .select('id, order_number')
      .eq('id', returnRequest.order_id)
      .single();
    
    console.log('[Admin Devoluciones Detail] Order error:', orderError?.message);
    orderData = order;
  }

  // Query 3: Obtener datos del cliente
  let customerData: any = null;
  if (returnRequest.customer_id) {
    const { data: customer, error: customerError } = await supabaseAdmin
      .from('customers')
      .select('first_name, last_name, email, phone')
      .eq('id', returnRequest.customer_id)
      .single();
    
    console.log('[Admin Devoluciones Detail] Customer error:', customerError?.message);
    customerData = customer;
  }

  // Query 4: Obtener items de la devolución
  const { data: items, error: itemsError } = await supabaseAdmin
    .from('return_request_items')
    .select('*')
    .eq('return_request_id', id);

  console.log('[Admin Devoluciones Detail] Items error:', itemsError?.message);

  // Formatear datos
  formattedReturn = {
    ...returnRequest,
    orders: orderData,
    customers: customerData,
    items: items || []
  };

  console.log('[Admin Devoluciones Detail] Datos formateados:', formattedReturn);

} catch (e) {
  console.error('[Admin Devoluciones Detail] Exception:', e);
  return Astro.redirect('/admin/devoluciones');
}

// Validar que se obtuvo la devolución
if (!formattedReturn) {
  console.error('[Admin Devoluciones Detail] formattedReturn es null');
  return Astro.redirect('/admin/devoluciones');
}
---

---

<AdminLayout title={`Devolución - ${formattedReturn?.id?.slice(0, 8) || 'Error'}`}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    {/* Encabezado con navegación */}
    <div class="mb-8 flex items-center justify-between">
      <div>
        <a href="/admin/devoluciones" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Volver a Devoluciones
        </a>
      </div>
      <div class="text-sm text-gray-500">
        ID: {formattedReturn?.id?.slice(0, 8) || 'Error'}
      </div>
    </div>

    {/* Título */}
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-primary-900 mb-2">
        Solicitud de Devolución
      </h1>
      <p class="text-gray-600">
        Pedido #{formattedReturn?.orders?.order_number || 'N/A'}
      </p>
    </div>

    {/* Contenido principal */}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      {/* Columna principal */}
      <div class="lg:col-span-2 space-y-6">
        
        {/* Información del Cliente */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Cliente
          </h2>
          <div class="space-y-3">
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Nombre</p>
              <p class="text-lg font-semibold text-gray-900">
                {formattedReturn?.customers?.first_name} {formattedReturn?.customers?.last_name}
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Email</p>
              <p class="text-gray-700">
                <a href={`mailto:${formattedReturn?.customers?.email}`} class="text-blue-600 hover:underline">
                  {formattedReturn?.customers?.email}
                </a>
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Teléfono</p>
              <p class="text-gray-700">
                {formattedReturn?.customers?.phone || 'No disponible'}
              </p>
            </div>
          </div>
        </div>

        {/* Detalles de la Devolución */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-amber-500">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Detalles
          </h2>
          <div class="space-y-3">
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Motivo</p>
              <p class="text-gray-900 font-medium">{formattedReturn?.reason || 'N/A'}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Descripción</p>
              <p class="text-gray-700 whitespace-pre-wrap">
                {formattedReturn?.description || 'Sin descripción'}
              </p>
            </div>
            <div class="pt-3 border-t">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Monto de Reembolso</p>
              <p class="text-2xl font-bold text-green-600">
                €{formattedReturn?.refund_amount?.toFixed(2) || '0.00'}
              </p>
            </div>
          </div>
        </div>

        {/* Artículos */}
        {formattedReturn?.items && formattedReturn.items.length > 0 && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              Artículos Devueltos
            </h2>
            <div class="space-y-3">
              {formattedReturn.items.map((item: any, idx: number) => (
                <div key={idx} class="pb-3 border-b last:border-b-0 last:pb-0">
                  <div class="flex justify-between items-start mb-1">
                    <p class="font-semibold text-gray-900">{item.product_name}</p>
                    <p class="font-semibold text-gray-900">
                      €{(item.unit_price * item.quantity).toFixed(2)}
                    </p>
                  </div>
                  <p class="text-sm text-gray-600">
                    Cantidad: {item.quantity} × €{item.unit_price?.toFixed(2)}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}

      </div>

      {/* Columna lateral - Estado y Acciones */}
      <div class="space-y-6">
        
        {/* Estado Actual */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Estado Actual</h2>
          <div class="space-y-4">
            <div>
              <span class={`px-4 py-2 rounded-full text-sm font-bold inline-block ${
                formattedReturn?.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                formattedReturn?.status === 'approved' ? 'bg-blue-100 text-blue-800' :
                formattedReturn?.status === 'shipped' ? 'bg-indigo-100 text-indigo-800' :
                formattedReturn?.status === 'received' ? 'bg-cyan-100 text-cyan-800' :
                formattedReturn?.status === 'refunded' ? 'bg-green-100 text-green-800' :
                formattedReturn?.status === 'rejected' ? 'bg-red-100 text-red-800' :
                'bg-gray-100 text-gray-800'
              }`}>
                {formattedReturn?.status?.toUpperCase() || 'N/A'}
              </span>
            </div>

            {/* Información de seguimiento */}
            {formattedReturn?.return_tracking_number && (
              <div class="pt-4 border-t">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Número de Seguimiento</p>
                <p class="font-mono text-sm text-gray-900 break-all">
                  {formattedReturn.return_tracking_number}
                </p>
              </div>
            )}
          </div>
        </div>

        {/* Historial */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-gray-500">
          <h2 class="text-lg font-bold text-gray-900 mb-4">Historial</h2>
          <div class="space-y-2 text-sm">
            <div>
              <p class="text-gray-500">Creada</p>
              <p class="text-gray-900 font-medium">
                {formattedReturn?.created_at ? new Date(formattedReturn.created_at).toLocaleString('es-ES') : 'N/A'}
              </p>
            </div>
            <div>
              <p class="text-gray-500">Última actualización</p>
              <p class="text-gray-900 font-medium">
                {formattedReturn?.updated_at ? new Date(formattedReturn.updated_at).toLocaleString('es-ES') : 'N/A'}
              </p>
            </div>
            {formattedReturn?.refunded_at && (
              <div>
                <p class="text-gray-500">Reembolsada</p>
                <p class="text-gray-900 font-medium">
                  {new Date(formattedReturn.refunded_at).toLocaleString('es-ES')}
                </p>
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  </div>
</AdminLayout>
