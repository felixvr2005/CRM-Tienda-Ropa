---
import AdminLayout from '@layouts/AdminLayout.astro';
import { supabaseAdmin } from '@lib/supabase';

export const prerender = false;

const { id } = Astro.params;

// Validar que el ID sea v√°lido
if (!id || typeof id !== 'string') {
  return Astro.redirect('/admin/devoluciones');
}

let formattedReturn: any = null;

try {
  console.log('[Admin Devoluciones Detail] Obteniendo devoluci√≥n:', id);
  
  // Query 1: Obtener la devoluci√≥n principal (sin relaciones)
  const { data: returnRequest, error: queryError } = await supabaseAdmin
    .from('return_requests')
    .select('*')
    .eq('id', id)
    .single();

  console.log('[Admin Devoluciones Detail] Error query 1:', queryError?.message);
  console.log('[Admin Devoluciones Detail] Datos query 1:', returnRequest);

  if (queryError || !returnRequest) {
    console.error('[Admin Devoluciones Detail] Devoluci√≥n no encontrada:', queryError?.message || 'No data');
    return Astro.redirect('/admin/devoluciones');
  }

  // Query 2: Obtener datos del pedido
  let orderData: any = null;
  if (returnRequest.order_id) {
    const { data: order, error: orderError } = await supabaseAdmin
      .from('orders')
      .select('id, order_number')
      .eq('id', returnRequest.order_id)
      .single();
    
    console.log('[Admin Devoluciones Detail] Order error:', orderError?.message);
    orderData = order;
  }

  // Query 3: Obtener datos del cliente
  let customerData: any = null;
  if (returnRequest.customer_id) {
    const { data: customer, error: customerError } = await supabaseAdmin
      .from('customers')
      .select('first_name, last_name, email, phone')
      .eq('id', returnRequest.customer_id)
      .single();
    
    console.log('[Admin Devoluciones Detail] Customer error:', customerError?.message);
    customerData = customer;
  }

  // Query 4: Obtener items de la devoluci√≥n
  const { data: items, error: itemsError } = await supabaseAdmin
    .from('return_request_items')
    .select('*')
    .eq('return_request_id', id);

  console.log('[Admin Devoluciones Detail] Items error:', itemsError?.message);

  // Formatear datos
  formattedReturn = {
    ...returnRequest,
    orders: orderData,
    customers: customerData,
    items: items || []
  };

  console.log('[Admin Devoluciones Detail] Datos formateados:', formattedReturn);

} catch (e) {
  console.error('[Admin Devoluciones Detail] Exception:', e);
  return Astro.redirect('/admin/devoluciones');
}

// Validar que se obtuvo la devoluci√≥n
if (!formattedReturn) {
  console.error('[Admin Devoluciones Detail] formattedReturn es null');
  return Astro.redirect('/admin/devoluciones');
}
---

<AdminLayout title={`Devoluci√≥n - ${formattedReturn?.id?.slice(0, 8) || 'Error'}`}>
  <div class="max-w-4xl mx-auto px-4 py-8">
    {/* Encabezado con navegaci√≥n */}
    <div class="mb-8 flex items-center justify-between">
      <div>
        <a href="/admin/devoluciones" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Volver a Devoluciones
        </a>
      </div>
      <div class="text-sm text-gray-500">
        ID: {formattedReturn?.id?.slice(0, 8) || 'Error'}
      </div>
    </div>

    {/* T√≠tulo */}
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-primary-900 mb-2">
        Solicitud de Devoluci√≥n
      </h1>
      <p class="text-gray-600">
        Pedido #{formattedReturn?.orders?.order_number || 'N/A'}
      </p>
    </div>

    {/* Contenido principal */}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      {/* Columna principal */}
      <div class="lg:col-span-2 space-y-6">
        
        {/* Informaci√≥n del Cliente */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Cliente
          </h2>
          <div class="space-y-3">
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Nombre</p>
              <p class="text-lg font-semibold text-gray-900">
                {formattedReturn?.customers?.first_name} {formattedReturn?.customers?.last_name}
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Email</p>
              <p class="text-gray-700">
                <a href={`mailto:${formattedReturn?.customers?.email}`} class="text-blue-600 hover:underline">
                  {formattedReturn?.customers?.email}
                </a>
              </p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Tel√©fono</p>
              <p class="text-gray-700">
                {formattedReturn?.customers?.phone || 'No disponible'}
              </p>
            </div>
          </div>
        </div>

        {/* Detalles de la Devoluci√≥n */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-amber-500">
          <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Detalles
          </h2>
          <div class="space-y-3">
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Motivo</p>
              <p class="text-gray-900 font-medium">{formattedReturn?.reason || 'N/A'}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">Descripci√≥n</p>
              <p class="text-gray-700 whitespace-pre-wrap">
                {formattedReturn?.description || 'Sin descripci√≥n'}
              </p>
            </div>
            <div class="pt-3 border-t">
              <p class="text-xs text-gray-500 uppercase tracking-wide">Monto de Reembolso</p>
              <p class="text-2xl font-bold text-green-600">
                ‚Ç¨{formattedReturn?.refund_amount?.toFixed(2) || '0.00'}
              </p>
            </div>
          </div>
        </div>

        {/* Art√≠culos */}
        {formattedReturn?.items && formattedReturn.items.length > 0 && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              Art√≠culos Devueltos
            </h2>
            <div class="space-y-3">
              {formattedReturn.items.map((item: any, idx: number) => (
                <div key={idx} class="pb-3 border-b last:border-b-0 last:pb-0">
                  <div class="flex justify-between items-start mb-1">
                    <p class="font-semibold text-gray-900">{item.product_name}</p>
                    <p class="font-semibold text-gray-900">
                      ‚Ç¨{(item.unit_price * item.quantity).toFixed(2)}
                    </p>
                  </div>
                  <p class="text-sm text-gray-600">
                    Cantidad: {item.quantity} √ó ‚Ç¨{item.unit_price?.toFixed(2)}
                  </p>
                </div>
              ))}
            </div>
          </div>
        )}

      </div>

      {/* Columna lateral - Estado y Acciones */}
      <div class="space-y-6">
        
        {/* Estado Actual */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Estado Actual</h2>
          <div class="space-y-4">
            <div>
              <span class={`px-4 py-2 rounded-full text-sm font-bold inline-block ${
                formattedReturn?.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                formattedReturn?.status === 'approved' ? 'bg-blue-100 text-blue-800' :
                formattedReturn?.status === 'shipped' ? 'bg-indigo-100 text-indigo-800' :
                formattedReturn?.status === 'received' ? 'bg-cyan-100 text-cyan-800' :
                formattedReturn?.status === 'refunded' ? 'bg-green-100 text-green-800' :
                formattedReturn?.status === 'rejected' ? 'bg-red-100 text-red-800' :
                formattedReturn?.status === 'label_sent' ? 'bg-purple-100 text-purple-800' :
                'bg-gray-100 text-gray-800'
              }`}>
                {formattedReturn?.status === 'pending' ? 'PENDIENTE' :
                 formattedReturn?.status === 'approved' ? 'APROBADA' :
                 formattedReturn?.status === 'label_sent' ? 'ETIQUETA ENVIADA' :
                 formattedReturn?.status === 'shipped' ? 'ENVIADO' :
                 formattedReturn?.status === 'received' ? 'RECIBIDO' :
                 formattedReturn?.status === 'refunded' ? 'REEMBOLSADO' :
                 formattedReturn?.status === 'rejected' ? 'RECHAZADO' :
                 formattedReturn?.status?.toUpperCase() || 'N/A'}
              </span>
            </div>

            {/* Informaci√≥n de seguimiento */}
            {formattedReturn?.return_tracking_number && (
              <div class="pt-4 border-t">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">N√∫mero de Seguimiento</p>
                <p class="font-mono text-sm text-gray-900 break-all">
                  {formattedReturn.return_tracking_number}
                </p>
              </div>
            )}
          </div>
        </div>

        {/* Formulario para Confirmar Devoluci√≥n */}
        {formattedReturn?.status === 'pending' && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-amber-500">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Confirmar Devoluci√≥n</h2>
            <form id="confirm-return-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  URL de Etiqueta de Env√≠o
                </label>
                <input 
                  type="url" 
                  name="labelUrl" 
                  placeholder="https://..." 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  N√∫mero de Seguimiento (opcional)
                </label>
                <input 
                  type="text" 
                  name="trackingNumber" 
                  placeholder="ej: 1234567890"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Notas (opcional)
                </label>
                <textarea 
                  name="notes" 
                  placeholder="Notas internas..."
                  rows={3}
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div class="flex gap-2">
                <button 
                  type="submit"
                  class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-semibold"
                >
                  Aprobar y Enviar Etiqueta
                </button>
                <button 
                  type="button"
                  id="reject-btn"
                  class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors font-semibold"
                >
                  Rechazar
                </button>
              </div>
            </form>
          </div>
        )}

        {/* Acciones para cambiar estado */}
        {(formattedReturn?.status === 'label_sent' || formattedReturn?.status === 'approved') && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-indigo-500">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Actualizar Estado</h2>
            <p class="text-sm text-gray-600 mb-4">
              El cliente ha recibido la etiqueta. Actualiza el estado cuando el paquete sea enviado.
            </p>
            <button 
              id="mark-shipped-btn"
              class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
            >
              Marcar como Enviado por Cliente
            </button>
          </div>
        )}

        {formattedReturn?.status === 'shipped' && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-cyan-500">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Paquete en Tr√°nsito</h2>
            <p class="text-sm text-gray-600 mb-4">
              El cliente ha enviado el paquete. Confirma la recepci√≥n cuando llegue al almac√©n.
            </p>
            <button 
              id="mark-received-btn"
              class="w-full bg-cyan-600 text-white py-2 px-4 rounded-lg hover:bg-cyan-700 transition-colors font-semibold"
            >
              Confirmar Recepci√≥n
            </button>
          </div>
        )}

        {formattedReturn?.status === 'received' && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Procesar Reembolso</h2>
            <p class="text-sm text-gray-600 mb-4">
              El paquete ha sido recibido. Procesa el reembolso al cliente.
            </p>
            <div class="bg-green-50 p-4 rounded-lg mb-4">
              <p class="text-sm text-green-800">
                <strong>Monto a reembolsar:</strong> ‚Ç¨{formattedReturn?.refund_amount?.toFixed(2) || '0.00'}
              </p>
            </div>
            <button 
              id="process-refund-btn"
              class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-semibold"
            >
              Procesar Reembolso via Stripe
            </button>
          </div>
        )}

        {formattedReturn?.status === 'refunded' && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <h2 class="text-lg font-bold text-gray-900 mb-4">‚úÖ Devoluci√≥n Completada</h2>
            <p class="text-sm text-gray-600">
              Esta devoluci√≥n ha sido procesada exitosamente y el reembolso ha sido emitido.
            </p>
            {formattedReturn?.stripe_refund_id && (
              <p class="text-xs text-gray-500 mt-2">
                Stripe Refund ID: {formattedReturn.stripe_refund_id}
              </p>
            )}
          </div>
        )}

        {formattedReturn?.status === 'rejected' && (
          <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
            <h2 class="text-lg font-bold text-gray-900 mb-4">‚ùå Devoluci√≥n Rechazada</h2>
            <p class="text-sm text-gray-600">
              Esta solicitud de devoluci√≥n fue rechazada.
            </p>
          </div>
        )}

        {/* Historial */}
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-gray-500">
          <h2 class="text-lg font-bold text-gray-900 mb-4">Historial</h2>
          <div class="space-y-2 text-sm">
            <div>
              <p class="text-gray-500">Creada</p>
              <p class="text-gray-900 font-medium">
                {formattedReturn?.created_at ? new Date(formattedReturn.created_at).toLocaleString('es-ES') : 'N/A'}
              </p>
            </div>
            <div>
              <p class="text-gray-500">√öltima actualizaci√≥n</p>
              <p class="text-gray-900 font-medium">
                {formattedReturn?.updated_at ? new Date(formattedReturn.updated_at).toLocaleString('es-ES') : 'N/A'}
              </p>
            </div>
            {formattedReturn?.refunded_at && (
              <div>
                <p class="text-gray-500">Reembolsada</p>
                <p class="text-gray-900 font-medium">
                  {new Date(formattedReturn.refunded_at).toLocaleString('es-ES')}
                </p>
              </div>
            )}
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const returnId = window.location.pathname.split('/').pop();

    // Funci√≥n auxiliar para actualizar estado
    async function updateReturnStatus(status: string, successMsg: string) {
      try {
        const response = await fetch(`/api/admin/returns/${returnId}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });

        const result = await response.json();

        if (response.ok) {
          window.toast?.success(successMsg);
          window.location.reload();
        } else {
          window.toast?.error('Error: ' + (result.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error:', error);
        window.toast?.error('Error al actualizar el estado');
      }
    }

    // Confirmar devoluci√≥n (aprobar y enviar etiqueta)
    document.getElementById('confirm-return-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.currentTarget as HTMLFormElement);
      
      try {
        const response = await fetch('/api/admin/confirm-return', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            returnId,
            status: 'label_sent',
            labelUrl: formData.get('labelUrl'),
            trackingNumber: formData.get('trackingNumber'),
            notes: formData.get('notes'),
          }),
        });

        const result = await response.json();

        if (response.ok) {
          window.toast?.success('‚úÖ Devoluci√≥n aprobada y correo enviado al cliente');
          window.location.reload();
        } else {
          window.toast?.error('Error: ' + (result.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error:', error);
        window.toast?.error('Error al confirmar la devoluci√≥n');
      }
    });

    // Rechazar devoluci√≥n
    document.getElementById('reject-btn')?.addEventListener('click', async () => {
      if (!confirm('¬øEst√°s seguro de rechazar esta devoluci√≥n?')) return;
      await updateReturnStatus('rejected', '‚ùå Devoluci√≥n rechazada');
    });

    // Marcar como enviado
    document.getElementById('mark-shipped-btn')?.addEventListener('click', async () => {
      await updateReturnStatus('shipped', 'üöö Estado actualizado: Enviado por cliente');
    });

    // Marcar como recibido
    document.getElementById('mark-received-btn')?.addEventListener('click', async () => {
      await updateReturnStatus('received', 'üì• Estado actualizado: Recibido en almac√©n');
    });

    // Procesar reembolso
    document.getElementById('process-refund-btn')?.addEventListener('click', async () => {
      if (!confirm('¬øProcesar el reembolso via Stripe? Esta acci√≥n no se puede deshacer.')) return;
      
      try {
        const response = await fetch(`/api/admin/returns/${returnId}/refund`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const result = await response.json();

        if (response.ok) {
          window.toast?.success(`üí∞ Reembolso procesado: ‚Ç¨${result.refundAmount?.toFixed(2) || '0.00'}`);
          window.location.reload();
        } else {
          window.toast?.error('Error: ' + (result.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error:', error);
        window.toast?.error('Error al procesar el reembolso');
      }
    });
  </script>
</AdminLayout>
