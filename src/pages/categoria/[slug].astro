---
/**
 * Category Page - SSR
 * Productos filtrados por categoría
 */
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import { supabase } from '@lib/supabase';

export const prerender = false;

const { slug } = Astro.params;

// Obtener la categoría por slug
const { data: category, error: categoryError } = await supabase
  .from('categories')
  .select('*')
  .eq('slug', slug)
  .eq('is_active', true)
  .single();

// Si no existe la categoría, redirigir a productos
if (!category || categoryError) {
  return Astro.redirect('/productos');
}

// Obtener productos de esta categoría
const { data: products } = await supabase
  .from('products')
  .select(`
    *,
    category:categories(id, name, slug),
    variants:product_variants(*)
  `)
  .eq('category_id', category.id)
  .eq('is_active', true)
  .order('created_at', { ascending: false });

// Normalizar precios (vienen en céntimos)
const normalizedProducts = (products || []).map(product => ({
  ...product,
  price: product.price / 100,
  compare_at_price: product.compare_at_price ? product.compare_at_price / 100 : null
}));
---

<PublicLayout title={category.name}>
  <div class="max-w-[1800px] mx-auto px-4 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm text-primary-500 mb-8">
      <a href="/" class="hover:text-primary-900">Inicio</a>
      <span class="mx-2">/</span>
      <a href="/productos" class="hover:text-primary-900">Colección</a>
      <span class="mx-2">/</span>
      <span class="text-primary-900">{category.name}</span>
    </nav>
    
    <!-- Category Header -->
    <div class="text-center mb-12">
      <h1 class="font-display text-4xl md:text-5xl mb-4">{category.name}</h1>
      {category.description && (
        <p class="text-primary-600 max-w-2xl mx-auto">{category.description}</p>
      )}
    </div>
    
    <!-- Products Grid -->
    {normalizedProducts.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8">
        {normalizedProducts.map((product) => (
          <ProductCard product={product} showQuickAdd />
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <p class="text-primary-500 mb-4">No hay productos en esta categoría</p>
        <a href="/productos" class="text-sm underline hover:no-underline">Ver todos los productos</a>
      </div>
    )}
  </div>
</PublicLayout>
