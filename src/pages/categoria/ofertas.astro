---
/**
 * Ofertas/Sale Page - SSR
 * Productos con descuento
 */
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductCard from '@components/product/ProductCard.astro';
import { supabase } from '@lib/supabase';

export const prerender = false;

// Obtener productos en oferta
const { data: products } = await supabase
  .from('products')
  .select(`
    *,
    category:categories(id, name, slug),
    variants:product_variants(id, size, color, color_hex, stock, price_modifier)
  `)
  .eq('is_active', true)
  .gt('discount_percentage', 0)
  .order('discount_percentage', { ascending: false })
  .limit(48);

const saleProducts = products || [];

// Calcular el mayor descuento
const maxDiscount = saleProducts.length > 0 
  ? Math.max(...saleProducts.map((p: any) => p.discount_percentage || 0))
  : 0;
---

<PublicLayout title="Ofertas | FashionStore">
  <div class="max-w-[1800px] mx-auto px-4 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm text-primary-500 mb-8">
      <a href="/" class="hover:text-primary-900">Inicio</a>
      <span class="mx-2">/</span>
      <span class="text-primary-900">Ofertas</span>
    </nav>
    
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="font-display text-4xl md:text-5xl mb-4">OFERTAS</h1>
      <p class="text-primary-600 max-w-2xl mx-auto">
        Aprovecha nuestros descuentos exclusivos en prendas seleccionadas.
      </p>
    </div>

    <!-- Sale Banner -->
    <div class="relative h-64 md:h-80 mb-12 overflow-hidden bg-red-600">
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="text-center text-white">
          <span class="text-6xl md:text-8xl font-display">SALE</span>
          {maxDiscount > 0 && (
            <p class="text-2xl md:text-3xl mt-2">Hasta -{maxDiscount}%</p>
          )}
          <p class="text-lg opacity-90 mt-4">Ofertas por tiempo limitado</p>
        </div>
      </div>
      <!-- Decorative elements -->
      <div class="absolute top-4 left-4 text-white/20 text-6xl font-display">%</div>
      <div class="absolute bottom-4 right-4 text-white/20 text-6xl font-display">%</div>
    </div>
    
    <!-- Filter by discount -->
    {saleProducts.length > 0 && (
      <div class="flex flex-wrap gap-2 justify-center mb-8">
        <span class="px-4 py-2 bg-red-600 text-white text-sm">
          {saleProducts.length} productos en oferta
        </span>
      </div>
    )}
    
    <!-- Products Grid -->
    {saleProducts.length > 0 ? (
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8">
        {saleProducts.map((product: any) => (
          <ProductCard product={product} showQuickAdd />
        ))}
      </div>
    ) : (
      <div class="text-center py-16">
        <svg class="w-16 h-16 mx-auto mb-4 text-primary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a4 4 0 014-4z"/>
        </svg>
        <p class="text-primary-500 mb-4">No hay ofertas disponibles en este momento</p>
        <a href="/productos" class="inline-block bg-primary-900 text-white px-8 py-3 hover:bg-primary-800 transition-colors">
          VER COLECCIÃ“N
        </a>
      </div>
    )}
  </div>
</PublicLayout>
