---
/**
 * Product Detail Page - SSG
 * Página de detalle de producto con carga dinámica de imágenes por color
 */
import PublicLayout from '@layouts/PublicLayout.astro';
import ProductGallery from '@components/product/ProductGallery.astro';
import ProductCard from '@components/product/ProductCard.astro';
import ProductViewer from '@components/islands/ProductViewer';
import { supabase } from '@lib/supabase';
import { getProducts, getProductBySlug } from '@lib/supabase';
import { formatPrice, calculateDiscountedPrice } from '@lib/utils';

export const prerender = false;

// Obtener producto dinámicamente desde la BD
const { slug } = Astro.params;
const product = await getProductBySlug(slug || '');

if (!product) {
  return Astro.redirect('/productos');
}

const finalPrice = calculateDiscountedPrice(product.price, product.discount_percentage);
const hasDiscount = product.discount_percentage > 0;

// Productos relacionados (misma categoría)
const allProducts = await getProducts();
const relatedProducts = allProducts
  .filter(p => p.category_id === product.category_id && p.id !== product.id)
  .slice(0, 4);

// Cargar variantes con imágenes
const { data: variants } = await supabase
  .from('product_variants')
  .select('*')
  .eq('product_id', product.id);

console.log(`[Astro] Cargar variantes para producto ${product.id}:`, variants?.length);

// Cargar imágenes para cada variante
let variantImages: any = {};
if (variants && variants.length > 0) {
  for (const variant of variants) {
    const { data: images } = await supabase
      .from('variant_images')
      .select('*')
      .eq('variant_id', variant.id)
      .order('sort_order', { ascending: true });
    
    console.log(`[Astro] Variante ${variant.id} (${variant.color}): ${images?.length} imágenes`);
    variantImages[variant.id] = images || [];
  }
}

console.log('[Astro] variantImages keys:', Object.keys(variantImages).length);

// Imagen por defecto (primera imagen disponible o placeholder)
let defaultImages = ['/images/products/placeholder.jpg'];
if (variants && variants.length > 0) {
  const firstVariant = variants[0];
  if (variantImages[firstVariant.id] && variantImages[firstVariant.id].length > 0) {
    defaultImages = variantImages[firstVariant.id].map((img: any) => img.image_url);
  }
}
---

<PublicLayout title={product.name}>
  <div class="max-w-[1800px] mx-auto px-4 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm text-primary-500 mb-8">
      <a href="/" class="hover:text-primary-900">Inicio</a>
      <span class="mx-2">/</span>
      <a href="/productos" class="hover:text-primary-900">Colección</a>
      {product.category && (
        <>
          <span class="mx-2">/</span>
          <a href={`/categoria/${product.category.slug}`} class="hover:text-primary-900">
            {product.category.name}
          </a>
        </>
      )}
      <span class="mx-2">/</span>
      <span class="text-primary-900">{product.name}</span>
    </nav>
    
    <!-- Product Layout -->
    <ProductViewer
      client:load
      productId={product.id}
      productName={product.name}
      productSlug={product.slug}
      productPrice={product.price / 100}
      productDiscount={product.discount_percentage}
      productImage={defaultImages[0] || '/images/products/placeholder.jpg'}
      variants={variants || []}
      variantImages={variantImages}
    />
    
    <!-- Badges & Category -->
    {(product.is_new || product.discount_percentage > 0) && (
      <div class="mt-8 flex gap-2">
        {product.is_new && (
          <span class="bg-primary-900 text-white text-2xs tracking-widest uppercase px-2 py-1">
            Nuevo
          </span>
        )}
        {product.discount_percentage > 0 && (
          <span class="bg-red-600 text-white text-2xs tracking-widest uppercase px-2 py-1">
            -{product.discount_percentage}%
          </span>
        )}
      </div>
    )}
    
    <!-- Accordions -->
    <div class="mt-12 border-t border-primary-200 max-w-3xl">
      <details class="group">
        <summary class="flex items-center justify-between py-4 cursor-pointer">
          <span class="text-sm font-medium uppercase tracking-wider">Descripción del producto</span>
          <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7" />
          </svg>
        </summary>
        <div class="pb-4 text-sm text-primary-600">
          {product.description || 'Prenda de alta calidad diseñada con los mejores materiales.'}
        </div>
      </details>
      
      <details class="group border-t border-primary-200">
        <summary class="flex items-center justify-between py-4 cursor-pointer">
          <span class="text-sm font-medium uppercase tracking-wider">Composición y cuidados</span>
          <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7" />
          </svg>
        </summary>
        <div class="pb-4 text-sm text-primary-600 space-y-2">
          <p>100% Algodón premium</p>
          <p>Lavar a máquina máx. 30°C</p>
          <p>No usar secadora</p>
          <p>Planchar a temperatura media</p>
        </div>
      </details>
      
      <details class="group border-t border-primary-200">
        <summary class="flex items-center justify-between py-4 cursor-pointer">
          <span class="text-sm font-medium uppercase tracking-wider">Envío y devoluciones</span>
          <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7" />
          </svg>
        </summary>
        <div class="pb-4 text-sm text-primary-600 space-y-2">
          <p>Envío estándar: 2-4 días laborables (5,95€)</p>
          <p>Envío gratis en pedidos superiores a 100€</p>
          <p>Devolución gratuita en 30 días</p>
        </div>
      </details>
    </div>
    
    <!-- Related Products -->
    {relatedProducts.length > 0 && (
      <section class="mt-20">
        <h2 class="font-display text-2xl mb-8">También te puede gustar</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-8">
          {relatedProducts.map((p) => (
            <ProductCard product={p} />
          ))}
        </div>
      </section>
    )}
  </div>
</PublicLayout>
