---
import AccountLayout from '@layouts/AccountLayout.astro';
import { supabase } from '@lib/supabase';

export const prerender = false;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/perfil');
}

// Verificar autenticación con el token
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta/perfil');
}

// Manejar actualización del perfil
let successMessage = '';
let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    // Aceptar tanto FormData como JSON
    let data: Record<string, any> = {};
    const contentType = Astro.request.headers.get('content-type');
    
    if (contentType?.includes('application/json')) {
      data = await Astro.request.json();
    } else {
      const formData = await Astro.request.formData();
      for (const [key, value] of formData.entries()) {
        data[key] = value;
      }
    }

    const firstName = data.firstName as string;
    const lastName = data.lastName as string;
    const phone = data.phone as string;
    const birthDate = data.birthDate as string;
    const newsletter = data.newsletter === 'on' || data.newsletter === true;

    console.log('Actualizando perfil para user.id:', user.id);
    console.log('Datos a actualizar:', { firstName, lastName, phone, birthDate, newsletter });

    // Primero verificar si existe el registro del cliente
    const { data: existingCustomer, error: selectError } = await supabase
      .from('customers')
      .select('id')
      .eq('auth_user_id', user.id)
      .single();

    if (selectError && selectError.code === 'PGRST116') {
      // No existe, crear registro nuevo
      console.log('Cliente no existe, creando nuevo registro');
      const { error: insertError } = await supabase
        .from('customers')
        .insert({
          auth_user_id: user.id,
          email: user.email,
          first_name: firstName,
          last_name: lastName,
          phone: phone || null,
          birth_date: birthDate || null,
          newsletter_subscribed: newsletter,
        });
      if (insertError) throw insertError;
    } else if (existingCustomer) {
      // Existe, actualizar
      console.log('Cliente existe, actualizando ID:', existingCustomer.id);
      const { error: updateError } = await supabase
        .from('customers')
        .update({
          first_name: firstName,
          last_name: lastName,
          phone: phone || null,
          birth_date: birthDate || null,
          newsletter_subscribed: newsletter,
          updated_at: new Date().toISOString()
        })
        .eq('id', existingCustomer.id);
      
      if (updateError) throw updateError;
    }

    successMessage = 'Perfil actualizado correctamente';
  } catch (err: any) {
    console.error('Error actualizando perfil:', err);
    errorMessage = err.message || 'Error al actualizar el perfil';
  }
}

// Obtener perfil actualizado del cliente (SIEMPRE después del POST)
const { data: updatedCustomer } = await supabase
  .from('customers')
  .select('*')
  .eq('auth_user_id', user.id)
  .single();
---

<AccountLayout title="Mi Perfil">
  <div class="space-y-6">
    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
        {successMessage}
      </div>
    )}
    {errorMessage && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        {errorMessage}
      </div>
    )}

    <h1 class="text-2xl font-bold text-primary-900">Mi Perfil</h1>

    <div class="bg-white border border-primary-200 rounded-lg p-6">
      <form method="POST" class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="firstName" class="block text-sm font-medium text-primary-900 mb-2">
              Nombre
            </label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              value={updatedCustomer?.first_name || ''}
              class="w-full px-4 py-2 border border-primary-300 rounded focus:outline-none focus:border-primary-900"
            />
          </div>
          <div>
            <label for="lastName" class="block text-sm font-medium text-primary-900 mb-2">
              Apellido
            </label>
            <input
              type="text"
              id="lastName"
              name="lastName"
              value={updatedCustomer?.last_name || ''}
              class="w-full px-4 py-2 border border-primary-300 rounded focus:outline-none focus:border-primary-900"
            />
          </div>
        </div>

        <div>
          <label for="email" class="block text-sm font-medium text-primary-900 mb-2">
            Correo Electrónico
          </label>
          <input
            type="email"
            id="email"
            value={user.email}
            disabled
            class="w-full px-4 py-2 border border-primary-300 rounded bg-primary-50"
          />
        </div>

        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label for="phone" class="block text-sm font-medium text-primary-900 mb-2">
              Teléfono
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              value={updatedCustomer?.phone || ''}
              class="w-full px-4 py-2 border border-primary-300 rounded focus:outline-none focus:border-primary-900"
            />
          </div>
          <div>
            <label for="birthDate" class="block text-sm font-medium text-primary-900 mb-2">
              Fecha de Nacimiento
            </label>
            <input
              type="date"
              id="birthDate"
              name="birthDate"
              value={updatedCustomer?.birth_date ? updatedCustomer.birth_date.split('T')[0] : ''}
              class="w-full px-4 py-2 border border-primary-300 rounded focus:outline-none focus:border-primary-900"
            />
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            id="newsletter"
            name="newsletter"
            checked={updatedCustomer?.newsletter_opt_in}
            class="w-4 h-4"
          />
          <label for="newsletter" class="text-sm text-primary-900">
            Deseo recibir información sobre nuevos productos y promociones
          </label>
        </div>

        <button
          type="submit"
          class="w-full py-3 bg-primary-900 text-white rounded hover:bg-primary-800 transition-colors"
        >
          Guardar Cambios
        </button>
      </form>
    </div>
  </div>
</AccountLayout>
      </aside>

      <!-- Main Content -->
      <div class="lg:col-span-3">
        <h1 class="text-2xl font-light mb-6">MI PERFIL</h1>

        {successMessage && (
          <div class="mb-6 p-4 bg-green-50 border border-green-200 text-green-800">
            {successMessage}
          </div>
        )}

        {errorMessage && (
          <div class="mb-6 p-4 bg-red-50 border border-red-200 text-red-800">
            {errorMessage}
          </div>
        )}

        <div class="space-y-6">
          <!-- Profile Form -->
          <form method="POST" class="bg-white border border-primary-200 p-6">
            <h2 class="text-lg font-medium mb-6">Información Personal</h2>
            
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label for="firstName" class="block text-sm font-medium text-primary-700 mb-2">
                  Nombre *
                </label>
                <input
                  type="text"
                  id="firstName"
                  name="firstName"
                  value={updatedCustomer?.first_name || ''}
                  required
                  class="w-full px-4 py-3 border border-primary-300 focus:border-primary-900 focus:ring-0 outline-none transition-colors"
                />
              </div>

              <div>
                <label for="lastName" class="block text-sm font-medium text-primary-700 mb-2">
                  Apellidos *
                </label>
                <input
                  type="text"
                  id="lastName"
                  name="lastName"
                  value={updatedCustomer?.last_name || ''}
                  required
                  class="w-full px-4 py-3 border border-primary-300 focus:border-primary-900 focus:ring-0 outline-none transition-colors"
                />
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-primary-700 mb-2">
                  Email
                </label>
                <input
                  type="email"
                  id="email"
                  value={user.email}
                  disabled
                  class="w-full px-4 py-3 border border-primary-200 bg-primary-50 text-primary-500 cursor-not-allowed"
                />
                <p class="text-xs text-primary-500 mt-1">El email no se puede cambiar</p>
              </div>

              <div>
                <label for="phone" class="block text-sm font-medium text-primary-700 mb-2">
                  Teléfono
                </label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  value={updatedCustomer?.phone || ''}
                  placeholder="+34 600 000 000"
                  class="w-full px-4 py-3 border border-primary-300 focus:border-primary-900 focus:ring-0 outline-none transition-colors"
                />
              </div>

              <div>
                <label for="birthDate" class="block text-sm font-medium text-primary-700 mb-2">
                  Fecha de Nacimiento
                </label>
                <input
                  type="date"
                  id="birthDate"
                  name="birthDate"
                  value={updatedCustomer?.birth_date || ''}
                  class="w-full px-4 py-3 border border-primary-300 focus:border-primary-900 focus:ring-0 outline-none transition-colors"
                />
                <p class="text-xs text-primary-500 mt-1">Recibe un descuento especial en tu cumpleaños</p>
              </div>

              <div class="flex items-center">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    name="newsletter"
                    checked={updatedCustomer?.newsletter_subscribed}
                    class="w-5 h-5 border-primary-300 text-primary-900 focus:ring-primary-900"
                  />
                  <span class="text-sm">
                    Quiero recibir novedades y ofertas exclusivas por email
                  </span>
                </label>
              </div>
            </div>

            <div class="mt-6 pt-6 border-t border-primary-200">
              <button
                type="submit"
                class="px-8 py-3 bg-primary-900 text-white hover:bg-primary-800 transition-colors"
              >
                GUARDAR CAMBIOS
              </button>
            </div>
          </form>

          <!-- Change Password -->
          <div class="bg-white border border-primary-200 p-6">
            <h2 class="text-lg font-medium mb-4">Cambiar Contraseña</h2>
            <p class="text-primary-500 mb-4">
              Para cambiar tu contraseña, te enviaremos un enlace a tu email.
            </p>
            <button
              id="resetPasswordBtn"
              type="button"
              class="px-6 py-2 border border-primary-900 text-primary-900 hover:bg-primary-900 hover:text-white transition-colors"
            >
              SOLICITAR CAMBIO DE CONTRASEÑA
            </button>
          </div>

          <!-- Delete Account -->
          <div class="bg-white border border-red-200 p-6">
            <h2 class="text-lg font-medium mb-4 text-red-600">Eliminar Cuenta</h2>
            <p class="text-primary-500 mb-4">
              Al eliminar tu cuenta, se borrarán todos tus datos personales. Esta acción no se puede deshacer.
              Tus pedidos anteriores se conservarán por motivos legales.
            </p>
            <button
              id="deleteAccountBtn"
              type="button"
              class="px-6 py-2 border border-red-600 text-red-600 hover:bg-red-600 hover:text-white transition-colors"
            >
              ELIMINAR MI CUENTA
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</AccountLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  // Reset Password
  document.getElementById('resetPasswordBtn')?.addEventListener('click', async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user?.email) return;

    const { error } = await supabase.auth.resetPasswordForEmail(user.email, {
      redirectTo: `${window.location.origin}/cuenta/nueva-password`
    });

    if (error) {
      alert('Error al enviar el email: ' + error.message);
    } else {
      alert('Te hemos enviado un email para cambiar tu contraseña');
    }
  });

  // Delete Account
  document.getElementById('deleteAccountBtn')?.addEventListener('click', async () => {
    const confirmed = confirm(
      '¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.'
    );

    if (confirmed) {
      const doubleConfirmed = prompt(
        'Escribe "ELIMINAR" para confirmar la eliminación de tu cuenta:'
      );

      if (doubleConfirmed === 'ELIMINAR') {
        // En una implementación real, esto llamaría a una función del servidor
        alert('Tu solicitud de eliminación ha sido enviada. Recibirás un email de confirmación.');
      }
    }
  });
</script>
