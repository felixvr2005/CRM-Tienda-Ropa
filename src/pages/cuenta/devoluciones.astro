---
/**
 * Mi Cuenta - Devoluciones
 * P√°gina para ver historial de devoluciones y descargar notas de cr√©dito
 */
import PublicLayout from '@layouts/PublicLayout.astro';
import CreditNoteDownload from '@components/islands/CreditNoteDownload';
import { supabase, supabaseAdmin } from '@lib/supabase';

export const prerender = false;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/devoluciones');
}

// Verificar autenticaci√≥n
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta/devoluciones');
}

// Obtener customer
const { data: currentCustomer } = await supabaseAdmin
  .from('customers')
  .select('id')
  .eq('auth_user_id', user.id)
  .single();

if (!currentCustomer?.id) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/devoluciones');
}

// Obtener devoluciones del cliente
const { data: returnRequests } = await supabaseAdmin
  .from('return_requests')
  .select('*, orders(order_number), credit_notes(*)')
  .eq('customer_id', currentCustomer.id)
  .order('created_at', { ascending: false });

// Funciones de formato
const formatPrice = (price: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Estados de devoluci√≥n
const statusMap: Record<string, { label: string; color: string; icon: string }> = {
  'pending': { label: 'Pendiente', color: 'text-yellow-600', icon: '‚è≥' },
  'approved': { label: 'Aprobada', color: 'text-blue-600', icon: '‚úì' },
  'shipped': { label: 'Recibida', color: 'text-purple-600', icon: 'üì¶' },
  'completed': { label: 'Completada', color: 'text-green-600', icon: '‚úì' },
  'rejected': { label: 'Rechazada', color: 'text-red-600', icon: '‚úï' }
};
---

<PublicLayout title="Mis Devoluciones | FashionStore">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm text-primary-500 mb-8">
      <a href="/" class="hover:text-primary-900">Inicio</a>
      <span class="mx-2">/</span>
      <a href="/cuenta" class="hover:text-primary-900">Mi Cuenta</a>
      <span class="mx-2">/</span>
      <span class="text-primary-900">Devoluciones</span>
    </nav>

    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <h1 class="font-display text-3xl md:text-4xl">Mis Devoluciones</h1>
      <a 
        href="/cuenta/pedidos"
        class="text-sm text-primary-600 hover:text-primary-900 underline"
      >
        Ver todos los pedidos ‚Üí
      </a>
    </div>

    {!returnRequests || returnRequests.length === 0 ? (
      <div class="bg-white rounded-lg border border-primary-200 p-12 text-center">
        <svg class="w-16 h-16 mx-auto text-primary-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4m0 0l-8 4m8-4v10l-8-4v10l8 4 8-4V7" />
        </svg>
        <p class="text-primary-500 text-lg mb-4">A√∫n no has solicitado devoluciones</p>
        <a 
          href="/cuenta/pedidos"
          class="inline-block px-6 py-3 bg-primary-900 text-white text-sm font-medium hover:bg-primary-800 transition-colors"
        >
          Ver mis pedidos
        </a>
      </div>
    ) : (
      <div class="space-y-6">
        {returnRequests.map((returnReq: any) => {
          const status = statusMap[returnReq.status] || { label: returnReq.status, color: 'text-gray-600', icon: '?' };
          const creditNote = returnReq.credit_notes?.[0];

          return (
            <div class="bg-white rounded-lg border border-primary-200 p-6 hover:shadow-lg transition-shadow">
              {/* Header */}
              <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div>
                  <p class="text-sm text-primary-500">Pedido</p>
                  <a 
                    href={`/cuenta/pedidos/${returnReq.orders?.order_number}`}
                    class="text-xl font-semibold text-primary-900 hover:text-primary-600"
                  >
                    #{returnReq.orders?.order_number}
                  </a>
                </div>
                
                <div class="flex items-center gap-3">
                  <span class={`text-lg ${status.color}`}>{status.icon}</span>
                  <span class={`font-medium ${status.color}`}>{status.label}</span>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-6 pb-6 border-b border-primary-100">
                <div>
                  <p class="text-primary-500">Fecha de solicitud</p>
                  <p class="font-medium">{formatDate(returnReq.created_at)}</p>
                </div>
                <div>
                  <p class="text-primary-500">Motivo</p>
                  <p class="font-medium">{returnReq.reason || 'No especificado'}</p>
                </div>
              </div>

              {/* Acciones */}
              <div class="flex flex-col sm:flex-row gap-3">
                <a 
                  href={`/cuenta/pedidos/${returnReq.orders?.order_number}`}
                  class="flex items-center gap-2 px-4 py-2 border border-primary-300 text-primary-600 text-sm rounded-lg hover:bg-primary-50 transition-colors text-center justify-center"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Ver detalles
                </a>

                {creditNote && (
                  <CreditNoteDownload
                    client:load
                    returnRequestId={returnReq.id}
                    originalOrderId={returnReq.order_id}
                    orderNumber={returnReq.orders?.order_number}
                    authToken={accessToken}
                  />
                )}

                {returnReq.status === 'completed' && !creditNote && (
                  <button 
                    disabled
                    title="El abono se generar√° autom√°ticamente cuando la devoluci√≥n se complete"
                    class="px-4 py-2 bg-gray-300 text-gray-600 text-sm rounded-lg cursor-not-allowed"
                  >
                    Generar abono
                  </button>
                )}
              </div>

              {/* Info de abono */}
              {creditNote && (
                <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded text-sm">
                  <p class="text-green-700">
                    <strong>‚úì Abono procesado:</strong> Se abonaron {formatPrice(creditNote.refund_amount / 100)} a tu m√©todo de pago
                  </p>
                </div>
              )}
            </div>
          );
        })}
      </div>
    )}
  </div>
</PublicLayout>
