---
/**
 * Mi Cuenta - Detalles de Devoluci√≥n
 */
import AccountLayout from '@layouts/AccountLayout.astro';
import { supabase, supabaseAdmin } from '@lib/supabase';

export const prerender = false;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/devoluciones');
}

// Verificar autenticaci√≥n
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta/devoluciones');
}

// Obtener customer
const { data: currentCustomer } = await supabaseAdmin
  .from('customers')
  .select('id')
  .eq('auth_user_id', user.id)
  .single();

// Nota: No redirigimos inmediatamente si no existe fila en `customers` (guest checkout)
const { id } = Astro.params;
const url = new URL(Astro.request.url);
const debugMode = url.searchParams.get('debug') === 'true';

// Obtener devoluci√≥n y datos de la orden para validaci√≥n por email si hace falta
const { data: returnRequest, error } = await supabaseAdmin
  .from('return_requests')
  .select('*, orders(customer_id, customer_email, order_number), return_request_items(*), credit_notes(*)')
  .eq('id', id)
  .single();

if (!returnRequest) {
  if (debugMode) {
    return new Response(JSON.stringify({ error: 'not_found' }), { status: 404, headers: { 'Content-Type': 'application/json' } });
  }
  return Astro.redirect('/cuenta/devoluciones');
}

// If debug mode requested, return auth-check info immediately
if (debugMode) {
  let allowed = false;
  let reason = '';
  if (currentCustomer?.id) {
    if (returnRequest.customer_id === currentCustomer.id) {
      allowed = true; reason = 'customer_id matches currentCustomer';
    } else if (returnRequest.orders?.customer_id === currentCustomer.id) {
      allowed = true; reason = 'order.customer_id matches currentCustomer';
    }
  } else if (returnRequest.orders?.customer_email && returnRequest.orders.customer_email === user.email) {
    allowed = true; reason = 'order.customer_email matches user email (guest)';
  }

  return new Response(JSON.stringify({ user: { id: user.id, email: user.email }, customer: currentCustomer, returnRequest, allowed, reason }), { status: 200, headers: { 'Content-Type': 'application/json' } });
}
// Validar que el request pertenece al usuario actual
let allowed = false;
let authReason = '';
if (currentCustomer?.id) {
  if (returnRequest.customer_id === currentCustomer.id) {
    allowed = true;
    authReason = 'customer_id matches currentCustomer';
  }
  if (!allowed && returnRequest.orders?.customer_id === currentCustomer.id) {
    allowed = true;
    authReason = 'order.customer_id matches currentCustomer';
  }
} else {
  // No hay fila customers -> permitir si la orden tiene el mismo email que el usuario (guest checkout)
  if (returnRequest.orders?.customer_email && returnRequest.orders.customer_email === user.email) {
    allowed = true;
    authReason = 'order.customer_email matches user email (guest)';
  }
}

if (!allowed) {
  // No pertenece al usuario -> log para debugging y redirigir a la lista
  console.log('Unauthorized access to return detail', { returnId: id, user: user?.email, customer: currentCustomer?.id, orderCustomerId: returnRequest.orders?.customer_id, orderEmail: returnRequest.orders?.customer_email });
  return Astro.redirect('/cuenta/devoluciones');
}

// Normalizar campos para evitar errores de runtime en cliente
const safeReturnRequest = {
  ...returnRequest,
  return_request_items: Array.isArray(returnRequest.return_request_items) ? returnRequest.return_request_items : [],
  credit_notes: Array.isArray(returnRequest.credit_notes) ? returnRequest.credit_notes : [],
  refund_amount: returnRequest.refund_amount || 0,
  notes: returnRequest.notes || ''
};


// Funciones de formato
const formatPrice = (price: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Mapeo de estados
const statusMap: Record<string, { label: string; color: string; icon: string }> = {
  'pending': { label: 'Pendiente', color: 'text-yellow-600', icon: '‚è≥' },
  'label_sent': { label: 'Etiqueta Enviada', color: 'text-blue-600', icon: 'üìß' },
  'approved': { label: 'Aprobada', color: 'text-blue-600', icon: '‚úì' },
  'shipped': { label: 'Enviada', color: 'text-purple-600', icon: 'üöö' },
  'received': { label: 'Recibida', color: 'text-indigo-600', icon: 'üì•' },
  'refunded': { label: 'Reembolsada', color: 'text-green-600', icon: '‚úì' },
  'completed': { label: 'Completada', color: 'text-green-600', icon: '‚úì' },
  'rejected': { label: 'Rechazada', color: 'text-red-600', icon: '‚úï' }
};

const currentStatus = statusMap[returnRequest.status] || { label: returnRequest.status, color: 'text-gray-600', icon: '?' };
---

<AccountLayout title={`Devoluci√≥n #${returnRequest.id.slice(0,8)}`}>
  <div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="text-sm text-primary-500">
      <a href="/" class="hover:text-primary-900">Inicio</a>
      <span class="mx-2">/</span>
      <a href="/cuenta" class="hover:text-primary-900">Mi Cuenta</a>
      <span class="mx-2">/</span>
      <a href="/cuenta/devoluciones" class="hover:text-primary-900">Mis Devoluciones</a>
      <span class="mx-2">/</span>
      <span class="text-primary-900">Devoluci√≥n #{returnRequest.id.slice(0,8)}</span>
    </nav>

    <!-- Back Button -->
    <a 
      href="/cuenta/devoluciones"
      class="inline-flex items-center gap-2 text-primary-600 hover:text-primary-900 font-medium"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Volver a devoluciones
    </a>

    <!-- Main Content -->
    <div class="grid gap-6">
      <!-- Header Card -->
      <div class="bg-white rounded-lg border border-primary-200 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h1 class="font-display text-3xl text-primary-900 mb-2">Devoluci√≥n #{returnRequest.id.slice(0,8)}</h1>
            <p class="text-primary-500">{formatDate(returnRequest.created_at)}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class={`text-3xl ${currentStatus.color}`}>{currentStatus.icon}</span>
            <div>
              <p class="text-sm text-primary-500">Estado</p>
              <p class={`text-lg font-bold ${currentStatus.color}`}>{currentStatus.label}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalles de la Devoluci√≥n -->
      <div class="bg-white rounded-lg border border-primary-200 p-6">
        <h2 class="font-bold text-primary-900 mb-4">Detalles de la Devoluci√≥n</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <p class="text-sm text-primary-500 mb-1">Motivo</p>
            <p class="font-medium text-primary-900">{returnRequest.reason}</p>
          </div>
          <div>
            <p class="text-sm text-primary-500 mb-1">Descripci√≥n</p>
            <p class="font-medium text-primary-900">{returnRequest.notes || 'Sin descripci√≥n'}</p>
          </div>
          <div>
            <p class="text-sm text-primary-500 mb-1">Monto Solicitado</p>
            <p class="font-bold text-lg text-primary-900">{formatPrice(returnRequest.refund_amount || 0)}</p>
          </div>
          {returnRequest.label_code && (
            <div>
              <p class="text-sm text-primary-500 mb-1">C√≥digo de Etiqueta</p>
              <p class="font-mono font-semibold text-primary-900">{returnRequest.label_code}</p>
            </div>
          )}
        </div>
      </div>

      <!-- Art√≠culos en Devoluci√≥n -->
      <div class="bg-white rounded-lg border border-primary-200 p-6">
        <h2 class="font-bold text-primary-900 mb-4">Art√≠culos en Devoluci√≥n</h2>
        {safeReturnRequest.return_request_items && safeReturnRequest.return_request_items.length > 0 ? (
          <div class="space-y-4">
            {safeReturnRequest.return_request_items.map((item: any) => (
              <div class="flex gap-4 pb-4 border-b border-primary-100 last:border-0 last:pb-0">
                <div class="flex-1">
                  <p class="font-medium text-primary-900">{item.product_name}</p>
                  <p class="text-sm text-primary-500">Cantidad: {item.quantity}</p>
                  <p class="text-sm text-primary-500">Talla: {item.size || 'N/A'}</p>
                  <p class="text-sm text-primary-500">Color: {item.color || 'N/A'}</p>
                </div>
                <div class="text-right">
                  <p class="font-semibold text-primary-900">{formatPrice(item.unit_price)}</p>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p class="text-primary-500">No hay art√≠culos en esta devoluci√≥n</p>
        )}
      </div>

      <!-- Nota de Cr√©dito -->
      {safeReturnRequest.credit_notes && safeReturnRequest.credit_notes.length > 0 && (
        <div class="bg-white rounded-lg border border-primary-200 p-6">
          <h2 class="font-bold text-primary-900 mb-4">Nota de Cr√©dito</h2>
          {safeReturnRequest.credit_notes.map((creditNote: any) => (
            <div key={creditNote.id} class="space-y-3">
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-primary-500 mb-1">N√∫mero de Nota</p>
                  <p class="font-mono font-medium text-primary-900">{creditNote.id?.slice(0,8)}</p>
                </div>
                <div>
                  <p class="text-sm text-primary-500 mb-1">Monto</p>
                  <p class="font-bold text-lg text-primary-900">{formatPrice((creditNote.refund_amount || 0) / 100)}</p>
                </div>
                <div>
                  <p class="text-sm text-primary-500 mb-1">Estado</p>
                  <span class={`inline-block px-3 py-1 rounded text-sm font-semibold ${
                    creditNote.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                    creditNote.status === 'processed' ? 'bg-green-100 text-green-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {creditNote.status === 'pending' ? 'Pendiente' : creditNote.status === 'processed' ? 'Procesada' : creditNote.status}
                  </span>
                </div>
                <div>
                  <p class="text-sm text-primary-500 mb-1">Fecha de Creaci√≥n</p>
                  <p class="font-medium text-primary-900">{formatDate(creditNote.created_at)}</p>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      <!-- Informaci√≥n del Pedido Original -->
      {safeReturnRequest.orders && (
        <div class="bg-white rounded-lg border border-primary-200 p-6">
          <h2 class="font-bold text-primary-900 mb-4">Pedido Original</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-primary-500 mb-1">N√∫mero de Pedido</p>
              <a 
                href={`/cuenta/pedidos/${safeReturnRequest.orders.order_number}`}
                class="font-medium text-primary-600 hover:text-primary-900 underline"
              >
                #{safeReturnRequest.orders.order_number}
              </a>
            </div>
            <div>
              <p class="text-sm text-primary-500 mb-1">Total del Pedido</p>
              <p class="font-bold text-primary-900">{formatPrice(safeReturnRequest.orders.total_amount)}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>
</AccountLayout>
</AccountLayout>
