---
import PublicLayout from '@layouts/PublicLayout.astro';
import { supabase } from '@lib/supabase';

export const prerender = false;

const { orderNumber } = Astro.params;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect(`/cuenta/login?redirect=/cuenta/pedidos/${orderNumber}`);
}

// Verificar autenticaci√≥n con el token
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect(`/cuenta/login?redirect=/cuenta/pedidos/${orderNumber}`);
}

// Obtener el pedido con detalles
const { data: order } = await supabase
  .from('orders')
  .select(`
    *,
    customer:customers(id, auth_user_id, first_name, last_name, email),
    order_items(
      id,
      quantity,
      unit_price,
      total_price,
      product_variant:product_variants(
        id,
        color,
        size,
        product:products(id, name, slug, images)
      )
    )
  `)
  .eq('order_number', orderNumber)
  .single();

if (!order || order.customer?.auth_user_id !== user.id) {
  return Astro.redirect('/cuenta/pedidos');
}

// Funciones de formato
const formatPrice = (price: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
};

const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Estados del pedido
const orderStatusMap: Record<string, { label: string; color: string; icon: string }> = {
  'pending': { label: 'Pendiente de pago', color: 'text-yellow-600', icon: '‚è≥' },
  'processing': { label: 'Procesando', color: 'text-blue-600', icon: 'üì¶' },
  'shipped': { label: 'Enviado', color: 'text-purple-600', icon: 'üöö' },
  'delivered': { label: 'Entregado', color: 'text-green-600', icon: '‚úì' },
  'cancelled': { label: 'Cancelado', color: 'text-red-600', icon: '‚úï' },
  'refunded': { label: 'Reembolsado', color: 'text-gray-600', icon: '‚Ü©' }
};

const currentStatus = orderStatusMap[order.status] || { label: order.status, color: 'text-gray-600', icon: '?' };

// Timeline del pedido
const timeline = [
  { status: 'pending', label: 'Pedido recibido', date: order.created_at },
  { status: 'processing', label: 'Preparando env√≠o', date: order.status !== 'pending' ? order.updated_at : null },
  { status: 'shipped', label: 'Enviado', date: order.tracking_number ? order.updated_at : null },
  { status: 'delivered', label: 'Entregado', date: order.status === 'delivered' ? order.updated_at : null }
];
---

<PublicLayout title={`Pedido #${orderNumber} | FashionStore`}>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
      <ol class="flex items-center gap-2 text-primary-500">
        <li><a href="/" class="hover:text-primary-900">Inicio</a></li>
        <li>/</li>
        <li><a href="/cuenta" class="hover:text-primary-900">Mi Cuenta</a></li>
        <li>/</li>
        <li><a href="/cuenta/pedidos" class="hover:text-primary-900">Mis Pedidos</a></li>
        <li>/</li>
        <li class="text-primary-900">#{orderNumber}</li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="flex flex-wrap items-start justify-between gap-4 mb-8">
      <div>
        <h1 class="text-2xl font-light mb-2">PEDIDO #{orderNumber}</h1>
        <p class="text-primary-500">Realizado el {formatDate(order.created_at)}</p>
      </div>
      <div class="flex items-center gap-2">
        <span class={`text-2xl ${currentStatus.color}`}>{currentStatus.icon}</span>
        <span class={`text-lg font-medium ${currentStatus.color}`}>{currentStatus.label}</span>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Order Status Timeline -->
        <div class="bg-white border border-primary-200 p-6">
          <h2 class="text-lg font-medium mb-6">Estado del Pedido</h2>
          <div class="relative">
            <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-primary-200"></div>
            <div class="space-y-6">
              {timeline.map((step, index) => {
                const isPast = timeline.findIndex(t => t.status === order.status) >= index;
                const isCurrent = step.status === order.status;
                return (
                  <div class="flex items-start gap-4 relative">
                    <div class={`w-8 h-8 rounded-full flex items-center justify-center z-10 ${
                      isPast ? 'bg-primary-900 text-white' : 'bg-primary-200 text-primary-400'
                    } ${isCurrent ? 'ring-4 ring-primary-100' : ''}`}>
                      {isPast ? '‚úì' : index + 1}
                    </div>
                    <div class="flex-1 pt-1">
                      <p class={`font-medium ${isPast ? 'text-primary-900' : 'text-primary-400'}`}>
                        {step.label}
                      </p>
                      {step.date && isPast && (
                        <p class="text-sm text-primary-500">{formatDate(step.date)}</p>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {order.tracking_number && (
            <div class="mt-6 pt-6 border-t border-primary-200">
              <p class="text-sm text-primary-500 mb-1">N√∫mero de seguimiento</p>
              <p class="font-mono text-lg">{order.tracking_number}</p>
              <a 
                href={`https://www.google.com/search?q=tracking+${order.tracking_number}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-block mt-2 text-sm text-primary-600 hover:text-primary-900 underline"
              >
                Rastrear env√≠o ‚Üí
              </a>
            </div>
          )}
        </div>

        <!-- Order Items -->
        <div class="bg-white border border-primary-200 p-6">
          <h2 class="text-lg font-medium mb-6">Productos ({order.order_items?.length || 0})</h2>
          <div class="space-y-4">
            {order.order_items?.map((item: any) => {
              const variant = item.product_variant;
              const product = variant?.product;
              return (
                <div class="flex gap-4 pb-4 border-b border-primary-100 last:border-0 last:pb-0">
                  <a 
                    href={`/productos/${product?.slug}`}
                    class="w-24 aspect-[3/4] bg-primary-100 flex-shrink-0"
                  >
                    {product?.images?.[0] && (
                      <img 
                        src={product.images[0]} 
                        alt={product.name}
                        class="w-full h-full object-cover"
                      />
                    )}
                  </a>
                  <div class="flex-1">
                    <a 
                      href={`/productos/${product?.slug}`}
                      class="font-medium hover:underline"
                    >
                      {product?.name}
                    </a>
                    <p class="text-sm text-primary-500 mt-1">
                      Color: {variant?.color} | Talla: {variant?.size}
                    </p>
                    <p class="text-sm text-primary-500">Cantidad: {item.quantity}</p>
                    <div class="flex items-center gap-2 mt-2">
                      <span class="font-medium">{formatPrice(item.price * item.quantity)}</span>
                      {item.original_price && item.original_price > item.price && (
                        <span class="text-sm text-primary-400 line-through">
                          {formatPrice(item.original_price * item.quantity)}
                        </span>
                      )}
                    </div>
                    {order.status === 'delivered' && (
                      <button class="mt-2 text-sm text-primary-600 hover:text-primary-900 underline">
                        Escribir rese√±a
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Order Summary -->
        <div class="bg-white border border-primary-200 p-6">
          <h2 class="text-lg font-medium mb-4">Resumen</h2>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-primary-500">Subtotal</span>
              <span>{formatPrice(order.subtotal)}</span>
            </div>
            {order.discount > 0 && (
              <div class="flex justify-between text-green-600">
                <span>Descuento</span>
                <span>-{formatPrice(order.discount)}</span>
              </div>
            )}
            <div class="flex justify-between">
              <span class="text-primary-500">Env√≠o</span>
              <span>{order.shipping_cost > 0 ? formatPrice(order.shipping_cost) : 'Gratis'}</span>
            </div>
            <div class="flex justify-between pt-3 border-t border-primary-200 text-lg font-medium">
              <span>Total</span>
              <span>{formatPrice(order.total)}</span>
            </div>
          </div>

          {order.coupon_code && (
            <div class="mt-4 pt-4 border-t border-primary-200">
              <p class="text-sm text-primary-500">Cup√≥n aplicado</p>
              <p class="font-mono">{order.coupon_code}</p>
            </div>
          )}
        </div>

        <!-- Shipping Address -->
        <div class="bg-white border border-primary-200 p-6">
          <h2 class="text-lg font-medium mb-4">Direcci√≥n de Env√≠o</h2>
          {order.shipping_address ? (
            <div class="text-sm space-y-1">
              <p class="font-medium">{order.shipping_address.name}</p>
              <p>{order.shipping_address.street}</p>
              {order.shipping_address.street2 && <p>{order.shipping_address.street2}</p>}
              <p>{order.shipping_address.postal_code} {order.shipping_address.city}</p>
              <p>{order.shipping_address.province}, {order.shipping_address.country}</p>
              {order.shipping_address.phone && <p class="mt-2">Tel: {order.shipping_address.phone}</p>}
            </div>
          ) : (
            <p class="text-sm text-primary-500">No disponible</p>
          )}
        </div>

        <!-- Payment Method -->
        <div class="bg-white border border-primary-200 p-6">
          <h2 class="text-lg font-medium mb-4">M√©todo de Pago</h2>
          <div class="flex items-center gap-3">
            <div class="w-10 h-6 bg-primary-100 rounded flex items-center justify-center text-xs font-bold">
              {order.payment_method === 'card' ? 'üí≥' : 'üè¶'}
            </div>
            <div>
              <p class="text-sm font-medium">
                {order.payment_method === 'card' ? 'Tarjeta de cr√©dito/d√©bito' : 'Transferencia bancaria'}
              </p>
              {order.stripe_payment_intent && (
                <p class="text-xs text-primary-500">Ref: {order.stripe_payment_intent.slice(-8)}</p>
              )}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="space-y-3">
          <a 
            href="/cuenta/pedidos"
            class="block w-full text-center px-4 py-3 border border-primary-900 text-primary-900 hover:bg-primary-900 hover:text-white transition-colors"
          >
            ‚Üê VOLVER A MIS PEDIDOS
          </a>
          
          {order.status === 'delivered' && (
            <button class="w-full px-4 py-3 border border-primary-300 text-primary-600 hover:border-primary-900 transition-colors">
              SOLICITAR DEVOLUCI√ìN
            </button>
          )}
          
          <button 
            onclick="window.print()"
            class="w-full px-4 py-3 border border-primary-300 text-primary-600 hover:border-primary-900 transition-colors"
          >
            IMPRIMIR PEDIDO
          </button>

          <a 
            href={`mailto:soporte@fashionstore.com?subject=Consulta sobre pedido ${orderNumber}`}
            class="block w-full text-center px-4 py-3 border border-primary-300 text-primary-600 hover:border-primary-900 transition-colors"
          >
            CONTACTAR SOPORTE
          </a>
        </div>
      </div>
    </div>
  </main>
</PublicLayout>

<style>
  @media print {
    nav, button, .no-print {
      display: none !important;
    }
  }
</style>
