---
import AccountLayout from '@layouts/AccountLayout.astro';
import { supabase, supabaseAdmin } from '@lib/supabase';

export const prerender = false;

const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/favoritos');
}

const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta/favoritos');
}

const { data: customer } = await supabaseAdmin
  .from('customers')
  .select('id')
  .eq('auth_user_id', user.id)
  .single();

// Solo consultar favoritos si tenemos un customer válido
let wishlistItems: any[] = [];
let debugInfo = { 
  customerId: customer?.id, 
  wishlistCount: 0, 
  productIds: [] as string[],
  productsFound: 0,
  error: ''
};

if (customer?.id) {
  // Primero obtener los wishlists
  const { data: wishlists, error: wishlistError } = await supabaseAdmin
    .from('wishlists')
    .select('id, product_id, created_at')
    .eq('customer_id', customer.id)
    .order('created_at', { ascending: false });
  
  if (wishlistError) {
    debugInfo.error = `Wishlist error: ${wishlistError.message}`;
  }
  
  debugInfo.wishlistCount = wishlists?.length || 0;
  
  if (wishlists && wishlists.length > 0) {
    // Obtener los IDs de productos
    const productIds = wishlists.map(w => w.product_id).filter(Boolean);
    debugInfo.productIds = productIds;
    
    if (productIds.length > 0) {
      // Obtener productos - query simplificada primero
      const { data: products, error: productsError } = await supabaseAdmin
        .from('products')
        .select('*')
        .in('id', productIds);
      
      if (productsError) {
        debugInfo.error += ` Products error: ${productsError.message}`;
      }
      
      debugInfo.productsFound = products?.length || 0;
      
      if (products && products.length > 0) {
        // Obtener variantes por separado
        const { data: allVariants } = await supabaseAdmin
          .from('product_variants')
          .select('*')
          .in('product_id', productIds);
        
        // Mapear wishlists con productos y variantes
        wishlistItems = wishlists.map(wishlist => {
          const product = products.find(p => p.id === wishlist.product_id);
          if (!product) return null;
          
          const variants = allVariants?.filter(v => v.product_id === product.id) || [];
          
          return {
            id: wishlist.id,
            created_at: wishlist.created_at,
            product: {
              ...product,
              variants
            }
          };
        }).filter(Boolean);
      }
    }
  }
}

const favoriteProducts = wishlistItems.map((item: any) => {
  const product = item.product;
  const variants = product?.variants || [];
  
  const minPrice = variants.length > 0 
    ? Math.min(...variants.map((v: any) => v.price))
    : 0;
  const minOriginalPrice = variants.length > 0
    ? Math.min(...variants.map((v: any) => v.original_price || v.price))
    : 0;

  const colors = [...new Set(variants.map((v: any) => v.color))];

  return {
    ...product,
    price: minPrice,
    originalPrice: minOriginalPrice > minPrice ? minOriginalPrice : null,
    colors,
    wishlistId: item.id,
    addedAt: item.created_at
  };
}).filter((p: any) => p && p.id) || [];

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
};
---

<AccountLayout title="Mis Favoritos">
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold text-primary-900">
        Mis Favoritos
        {favoriteProducts.length > 0 && (
          <span class="text-primary-500 text-lg ml-2">({favoriteProducts.length})</span>
        )}
      </h1>
    </div>

    {favoriteProducts.length === 0 ? (
      <div class="bg-white border border-primary-200 rounded-lg p-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-primary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <h2 class="text-xl font-medium mb-2">Tu lista de favoritos está vacía</h2>
        <p class="text-primary-500 mb-6">Guarda tus productos favoritos para encontrarlos fácilmente</p>
        <!-- Debug info detallado -->
        <div class="text-xs text-gray-400 mb-4 text-left bg-gray-50 p-4 rounded max-w-md mx-auto">
          <p>Customer ID: {debugInfo.customerId || 'N/A'}</p>
          <p>Wishlists encontrados: {debugInfo.wishlistCount}</p>
          <p>Product IDs: {debugInfo.productIds?.join(', ') || 'ninguno'}</p>
          <p>Productos encontrados: {debugInfo.productsFound}</p>
          {debugInfo.error && <p class="text-red-500">Error: {debugInfo.error}</p>}
        </div>
        <a href="/productos" class="inline-block bg-primary-900 text-white px-8 py-3 rounded hover:bg-primary-800 transition-colors">
          Explorar Productos
        </a>
      </div>
    ) : (
      <>
        <div class="flex gap-4 flex-wrap">
          <button
            id="addAllToCartBtn"
            class="px-4 py-2 border border-primary-900 text-primary-900 hover:bg-primary-900 hover:text-white transition-colors text-sm rounded disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Añadir Todo al Carrito
          </button>
          <button
            id="clearWishlistBtn"
            class="px-4 py-2 border border-red-300 text-red-600 hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors text-sm rounded"
          >
            Vaciar Favoritos
          </button>
        </div>

        <!-- Datos de productos para el script -->
        <script id="favoriteProductsData" type="application/json" set:html={JSON.stringify(
          favoriteProducts.map((p: any) => ({
            id: p.id,
            name: p.name,
            slug: p.slug,
            price: p.price,
            originalPrice: p.originalPrice,
            image: p.images?.[0] || '',
            wishlistId: p.wishlistId,
            variants: p.variants?.map((v: any) => ({
              id: v.id,
              size: v.size,
              color: v.color,
              stock: v.stock,
              price: v.price
            })) || []
          }))
        )} />

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {favoriteProducts.map((product: any) => {
            const hasStock = product.variants?.some((v: any) => v.stock > 0);
            return (
            <div class="relative group" data-product-id={product.id}>
              <button
                class="remove-wishlist-btn absolute top-2 right-2 z-10 w-8 h-8 bg-white/90 hover:bg-red-500 rounded-full flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100"
                data-wishlist-id={product.wishlistId}
                aria-label="Eliminar de favoritos"
              >
                <svg class="w-4 h-4 text-primary-600 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              
              <a href={`/productos/${product.slug}`} class="block">
                <div class="aspect-[3/4] bg-primary-100 mb-3 overflow-hidden rounded">
                  {product.images?.[0] ? (
                    <img 
                      src={product.images[0]} 
                      alt={product.name}
                      class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-primary-300">
                      Sin imagen
                    </div>
                  )}
                </div>
                <h3 class="text-sm font-medium truncate">{product.name}</h3>
                <p class="text-xs text-primary-500 mb-1">{product.category?.name}</p>
                <div class="flex items-center gap-2">
                  <span class="font-medium">{formatPrice(product.price)}</span>
                  {product.originalPrice && (
                    <span class="text-sm text-primary-400 line-through">
                      {formatPrice(product.originalPrice)}
                    </span>
                  )}
                </div>
                {!hasStock && (
                  <span class="text-xs text-red-500 mt-1 block">Sin stock</span>
                )}
              </a>
            </div>
          )})}
        </div>
      </>
    )}
  </div>
</AccountLayout>

<script>
  import { addToCart } from '@stores/cart';
  
  // Obtener datos de productos
  const productsDataEl = document.getElementById('favoriteProductsData');
  const favoriteProducts = productsDataEl ? JSON.parse(productsDataEl.textContent || '[]') : [];
  
  // Añadir Todo al Carrito
  document.getElementById('addAllToCartBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('addAllToCartBtn') as HTMLButtonElement;
    if (!btn) return;
    
    btn.disabled = true;
    btn.textContent = 'Añadiendo...';
    
    let addedCount = 0;
    const wishlistIdsToRemove: string[] = [];
    
    for (const product of favoriteProducts) {
      // Buscar primera variante con stock
      const availableVariant = product.variants?.find((v: any) => v.stock > 0);
      
      if (availableVariant) {
        try {
          // Añadir al carrito - precio ya está en centavos desde la BD
          const priceInEuros = availableVariant.price / 100;
          addToCart({
            id: availableVariant.id,
            productId: product.id,
            variantId: availableVariant.id,
            name: product.name,
            slug: product.slug,
            price: priceInEuros,
            originalPrice: product.originalPrice ? product.originalPrice / 100 : priceInEuros,
            discount: 0,
            image: product.image,
            size: availableVariant.size,
            color: availableVariant.color,
            maxStock: availableVariant.stock,
          });
          
          addedCount++;
          wishlistIdsToRemove.push(product.wishlistId);
        } catch (e) {
          console.error('Error añadiendo producto:', e);
        }
      }
    }
    
    // Eliminar de favoritos los productos añadidos
    if (wishlistIdsToRemove.length > 0) {
      for (const wishlistId of wishlistIdsToRemove) {
        try {
          await fetch('/api/wishlist/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wishlistId })
          });
        } catch (e) {
          console.error('Error eliminando favorito:', e);
        }
      }
    }
    
    if ((window as any).toast) {
      if (addedCount > 0) {
        (window as any).toast.success(`${addedCount} producto(s) añadido(s) al carrito`);
      } else {
        (window as any).toast.warning('No hay productos con stock disponible');
      }
    }
    
    // Recargar página para actualizar lista
    if (addedCount > 0) {
      setTimeout(() => window.location.reload(), 1000);
    } else {
      btn.disabled = false;
      btn.textContent = 'Añadir Todo al Carrito';
    }
  });

  // Eliminar de favoritos
  document.querySelectorAll('.remove-wishlist-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const button = e.currentTarget as HTMLElement;
      const wishlistId = button.dataset.wishlistId;
      const productCard = button.closest('.relative');
      
      if (!wishlistId) return;
      
      // Deshabilitar botón mientras procesa
      button.style.pointerEvents = 'none';
      button.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      
      try {
        const response = await fetch('/api/wishlist/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wishlistId })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Animar y remover la tarjeta
          if (productCard) {
            productCard.classList.add('opacity-0', 'scale-95', 'transition-all', 'duration-300');
            setTimeout(() => {
              productCard.remove();
              // Actualizar contador
              const counter = document.querySelector('h1 span');
              if (counter) {
                const current = parseInt(counter.textContent?.match(/\d+/)?.[0] || '0');
                if (current > 1) {
                  counter.textContent = `(${current - 1})`;
                } else {
                  // Recargar página si no quedan favoritos
                  window.location.reload();
                }
              }
            }, 300);
          }
          
          if ((window as any).toast) {
            (window as any).toast.success('Eliminado de favoritos');
          }
        } else {
          throw new Error(data.error || 'Error al eliminar');
        }
      } catch (error: any) {
        console.error('Error:', error);
        if ((window as any).toast) {
          (window as any).toast.error('Error al eliminar de favoritos');
        }
        // Restaurar botón
        button.style.pointerEvents = 'auto';
        button.innerHTML = '<svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      }
    });
  });
  
  // Vaciar todos los favoritos
  document.getElementById('clearWishlistBtn')?.addEventListener('click', async () => {
    if (!confirm('¿Estás seguro de vaciar toda tu lista de favoritos?')) return;
    
    try {
      const response = await fetch('/api/wishlist/clear', {
        method: 'POST'
      });
      
      if (response.ok) {
        window.location.reload();
      }
    } catch (error) {
      console.error('Error:', error);
    }
  });
</script>
