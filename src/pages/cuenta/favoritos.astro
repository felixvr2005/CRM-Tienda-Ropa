---
import AccountLayout from '@layouts/AccountLayout.astro';
import { supabase, supabaseAdmin } from '@lib/supabase';

export const prerender = false;

const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/favoritos');
}

const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta/favoritos');
}

const { data: customer } = await supabaseAdmin
  .from('customers')
  .select('id')
  .eq('auth_user_id', user.id)
  .single();

// Solo consultar favoritos si tenemos un customer válido
let wishlistItems: any[] = [];
if (customer?.id) {
  const { data } = await supabaseAdmin
    .from('wishlists')
    .select(`
      id,
      created_at,
      product:products (
        id,
        name,
        slug,
        description,
        images,
        category:categories!products_category_id_fkey (
          name,
          slug
        ),
        variants:product_variants (
          id,
          color,
          size,
          price,
          original_price,
          stock
        )
      )
    `)
    .eq('customer_id', customer.id)
    .order('created_at', { ascending: false });
  
  wishlistItems = data || [];
}

const favoriteProducts = wishlistItems?.map((item: any) => {
  const product = item.product;
  const variants = product?.variants || [];
  
  const minPrice = variants.length > 0 
    ? Math.min(...variants.map((v: any) => v.price))
    : 0;
  const minOriginalPrice = variants.length > 0
    ? Math.min(...variants.map((v: any) => v.original_price || v.price))
    : 0;

  const colors = [...new Set(variants.map((v: any) => v.color))];

  return {
    ...product,
    price: minPrice,
    originalPrice: minOriginalPrice > minPrice ? minOriginalPrice : null,
    colors,
    wishlistId: item.id,
    addedAt: item.created_at
  };
}).filter((p: any) => p && p.id) || [];

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR'
  }).format(price);
};
---

<AccountLayout title="Mis Favoritos">
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <h1 class="text-2xl font-bold text-primary-900">
        Mis Favoritos
        {favoriteProducts.length > 0 && (
          <span class="text-primary-500 text-lg ml-2">({favoriteProducts.length})</span>
        )}
      </h1>
    </div>

    {favoriteProducts.length === 0 ? (
      <div class="bg-white border border-primary-200 rounded-lg p-12 text-center">
        <svg class="w-16 h-16 mx-auto mb-4 text-primary-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
        <h2 class="text-xl font-medium mb-2">Tu lista de favoritos está vacía</h2>
        <p class="text-primary-500 mb-6">Guarda tus productos favoritos para encontrarlos fácilmente</p>
        <a href="/productos" class="inline-block bg-primary-900 text-white px-8 py-3 rounded hover:bg-primary-800 transition-colors">
          Explorar Productos
        </a>
      </div>
    ) : (
      <>
        <div class="flex gap-4">
          <button
            id="addAllToCartBtn"
            class="px-4 py-2 border border-primary-900 text-primary-900 hover:bg-primary-900 hover:text-white transition-colors text-sm rounded"
          >
            Añadir Todo al Carrito
          </button>
          <button
            id="clearWishlistBtn"
            class="px-4 py-2 border border-red-300 text-red-600 hover:bg-red-600 hover:text-white hover:border-red-600 transition-colors text-sm rounded"
          >
            Vaciar Favoritos
          </button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {favoriteProducts.map((product: any) => (
            <div class="relative group">
              <button
                class="remove-wishlist-btn absolute top-2 right-2 z-10 w-8 h-8 bg-white/90 hover:bg-red-500 rounded-full flex items-center justify-center transition-colors opacity-0 group-hover:opacity-100"
                data-wishlist-id={product.wishlistId}
                aria-label="Eliminar de favoritos"
              >
                <svg class="w-4 h-4 text-primary-600 group-hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
              
              <a href={`/productos/${product.slug}`} class="block">
                <div class="aspect-[3/4] bg-primary-100 mb-3 overflow-hidden rounded">
                  {product.images?.[0] ? (
                    <img 
                      src={product.images[0]} 
                      alt={product.name}
                      class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-primary-300">
                      Sin imagen
                    </div>
                  )}
                </div>
                <h3 class="text-sm font-medium truncate">{product.name}</h3>
                <p class="text-xs text-primary-500 mb-1">{product.category?.name}</p>
                <div class="flex items-center gap-2">
                  <span class="font-medium">{formatPrice(product.price)}</span>
                  {product.originalPrice && (
                    <span class="text-sm text-primary-400 line-through">
                      {formatPrice(product.originalPrice)}
                    </span>
                  )}
                </div>
              </a>
            </div>
          ))}
        </div>
      </>
    )}
  </div>
</AccountLayout>

