---
import PublicLayout from '@layouts/PublicLayout.astro';

export const prerender = false;

// Esta página se muestra después de hacer clic en el enlace de reseteo de contraseña
---

<PublicLayout title="Nueva Contraseña | FashionStore">
  <main class="max-w-md mx-auto px-4 py-16">
    <div class="bg-white border border-primary-200 p-8">
      <h1 class="text-2xl font-light text-center mb-2">NUEVA CONTRASEÑA</h1>
      <p class="text-primary-500 text-center mb-8">Introduce tu nueva contraseña</p>

      <form id="resetForm" class="space-y-6">
        <div>
          <label for="password" class="block text-sm font-medium text-primary-700 mb-2">
            Nueva contraseña
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="8"
            placeholder="Mínimo 8 caracteres"
            class="w-full px-4 py-3 border border-primary-300 focus:border-primary-900 focus:ring-0 outline-none transition-colors"
          />
        </div>

        <div>
          <label for="confirmPassword" class="block text-sm font-medium text-primary-700 mb-2">
            Confirmar contraseña
          </label>
          <input
            type="password"
            id="confirmPassword"
            name="confirmPassword"
            required
            minlength="8"
            placeholder="Repite la contraseña"
            class="w-full px-4 py-3 border border-primary-300 focus:border-primary-900 focus:ring-0 outline-none transition-colors"
          />
        </div>

        <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 text-red-800 text-sm"></div>
        <div id="successMessage" class="hidden p-4 bg-green-50 border border-green-200 text-green-800 text-sm"></div>

        <button
          type="submit"
          id="submitBtn"
          class="w-full py-3 bg-primary-900 text-white hover:bg-primary-800 transition-colors disabled:opacity-50"
        >
          ACTUALIZAR CONTRASEÑA
        </button>
      </form>

      <div class="mt-6 text-center">
        <a href="/cuenta/login" class="text-sm text-primary-600 hover:text-primary-900">
          ← Volver al inicio de sesión
        </a>
      </div>
    </div>
  </main>
</PublicLayout>

<script>
  import { createClient } from '@supabase/supabase-js';

  const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const form = document.getElementById('resetForm') as HTMLFormElement;
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  // Verificar que hay una sesión de recuperación
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'PASSWORD_RECOVERY') {
      // El usuario llegó desde el enlace de recuperación
      console.log('Password recovery mode');
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const password = (document.getElementById('password') as HTMLInputElement).value;
    const confirmPassword = (document.getElementById('confirmPassword') as HTMLInputElement).value;

    // Ocultar mensajes
    errorMessage?.classList.add('hidden');
    successMessage?.classList.add('hidden');

    // Validar contraseñas
    if (password !== confirmPassword) {
      errorMessage!.textContent = 'Las contraseñas no coinciden';
      errorMessage?.classList.remove('hidden');
      return;
    }

    if (password.length < 8) {
      errorMessage!.textContent = 'La contraseña debe tener al menos 8 caracteres';
      errorMessage?.classList.remove('hidden');
      return;
    }

    // Deshabilitar botón
    submitBtn.disabled = true;
    submitBtn.textContent = 'ACTUALIZANDO...';

    try {
      const { error } = await supabase.auth.updateUser({
        password: password
      });

      if (error) throw error;

      successMessage!.textContent = 'Contraseña actualizada correctamente. Redirigiendo...';
      successMessage?.classList.remove('hidden');
      
      setTimeout(() => {
        window.location.href = '/cuenta';
      }, 2000);
    } catch (error: any) {
      errorMessage!.textContent = error.message || 'Error al actualizar la contraseña';
      errorMessage?.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'ACTUALIZAR CONTRASEÑA';
    }
  });
</script>
