---
/**
 * Mi Cuenta - Dashboard del Cliente
 */
import PublicLayout from '@layouts/PublicLayout.astro';
import { supabase, supabaseAdmin } from '@lib/supabase';

export const prerender = false;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta');
}

// Verificar autenticación con el token
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  // Token inválido, limpiar cookies y redirigir
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta');
}

// Verificar que no sea admin
const { data: adminUser } = await supabaseAdmin
  .from('admin_users')
  .select('id, is_active')
  .eq('auth_user_id', user.id)
  .eq('is_active', true)
  .single();

if (adminUser) {
  // Es admin, no puede acceder a cuenta de cliente
  return Astro.redirect('/admin');
}

// Obtener perfil del cliente
const { data: customer } = await supabase
  .from('customers')
  .select('*')
  .eq('auth_user_id', user.id)
  .single();

// Obtener pedidos recientes
const { data: orders } = await supabase
  .from('orders')
  .select('*')
  .eq('customer_id', customer?.id)
  .order('created_at', { ascending: false })
  .limit(5);

// Calcular total gastado en tiempo real
const { data: allOrders } = await supabase
  .from('orders')
  .select('total_amount, subtotal')
  .eq('customer_id', customer?.id);

const totalSpent = (allOrders || []).reduce((sum, order) => {
  return sum + (order.total_amount || order.subtotal || 0);
}, 0);

const orderStatusMap: Record<string, string> = {
  pending: 'Pendiente',
  confirmed: 'Confirmado',
  processing: 'En proceso',
  shipped: 'Enviado',
  delivered: 'Entregado',
  cancelled: 'Cancelado',
  refunded: 'Reembolsado'
};

const orderStatusColors: Record<string, string> = {
  pending: 'bg-yellow-100 text-yellow-800',
  confirmed: 'bg-blue-100 text-blue-800',
  processing: 'bg-indigo-100 text-indigo-800',
  shipped: 'bg-purple-100 text-purple-800',
  delivered: 'bg-green-100 text-green-800',
  cancelled: 'bg-red-100 text-red-800',
  refunded: 'bg-gray-100 text-gray-800'
};
---

<PublicLayout title="Mi Cuenta | FashionStore">
  <main class="py-12">
    <div class="container max-w-6xl">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl font-display font-medium">
            Hola, {customer?.first_name || user.email?.split('@')[0]}
          </h1>
          <p class="text-primary-500 mt-1">{user.email}</p>
        </div>
        <button 
          id="logoutBtn"
          class="btn btn-outline py-2 px-6"
        >
          Cerrar Sesión
        </button>
      </div>

      <div class="grid md:grid-cols-4 gap-8">
        <!-- Sidebar -->
        <nav class="md:col-span-1">
          <ul class="space-y-1">
            <li>
              <a href="/cuenta" class="flex items-center gap-3 px-4 py-3 bg-primary-100 text-primary-900 font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Resumen
              </a>
            </li>
            <li>
              <a href="/cuenta/pedidos" class="flex items-center gap-3 px-4 py-3 hover:bg-primary-50 text-primary-600 hover:text-primary-900 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                Mis Pedidos
              </a>
            </li>
            <li>
              <a href="/cuenta/favoritos" class="flex items-center gap-3 px-4 py-3 hover:bg-primary-50 text-primary-600 hover:text-primary-900 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                Favoritos
              </a>
            </li>
            <li>
              <a href="/cuenta/direcciones" class="flex items-center gap-3 px-4 py-3 hover:bg-primary-50 text-primary-600 hover:text-primary-900 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Direcciones
              </a>
            </li>
            <li>
              <a href="/cuenta/perfil" class="flex items-center gap-3 px-4 py-3 hover:bg-primary-50 text-primary-600 hover:text-primary-900 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                Mi Perfil
              </a>
            </li>
            <li>
              <a href="/cuenta/cambiar-contraseña" class="flex items-center gap-3 px-4 py-3 hover:bg-primary-50 text-primary-600 hover:text-primary-900 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                Cambiar Contraseña
              </a>
            </li>
          </ul>
        </nav>

        <!-- Content -->
        <div class="md:col-span-3 space-y-8">
          <!-- Stats -->
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div class="bg-white border border-primary-200 p-6">
              <p class="text-sm text-primary-500 uppercase tracking-wider">Pedidos</p>
              <p class="text-3xl font-display font-medium mt-2">{customer?.total_orders || 0}</p>
            </div>
            <div class="bg-white border border-primary-200 p-6">
              <p class="text-sm text-primary-500 uppercase tracking-wider">Total Gastado</p>
              <p class="text-3xl font-display font-medium mt-2">{totalSpent.toFixed(2)}€</p>
            </div>
            <div class="bg-white border border-primary-200 p-6 col-span-2 md:col-span-1">
              <p class="text-sm text-primary-500 uppercase tracking-wider">Miembro desde</p>
              <p class="text-3xl font-display font-medium mt-2">
                {new Date(customer?.created_at || Date.now()).toLocaleDateString('es-ES', { month: 'short', year: 'numeric' })}
              </p>
            </div>
          </div>

          <!-- Pedidos Recientes -->
          <div class="bg-white border border-primary-200">
            <div class="p-6 border-b border-primary-200 flex items-center justify-between">
              <h2 class="text-lg font-medium">Pedidos Recientes</h2>
              <a href="/cuenta/pedidos" class="text-sm text-primary-600 hover:text-primary-900 link-underline">
                Ver todos
              </a>
            </div>
            
            {orders && orders.length > 0 ? (
              <div class="divide-y divide-primary-100">
                {orders.map((order) => (
                  <a href={`/cuenta/pedidos/${order.order_number}`} class="flex items-center justify-between p-6 hover:bg-primary-50 transition-colors">
                    <div>
                      <p class="font-medium">{order.order_number}</p>
                      <p class="text-sm text-primary-500 mt-1">
                        {new Date(order.created_at).toLocaleDateString('es-ES', { 
                          day: 'numeric', 
                          month: 'long', 
                          year: 'numeric' 
                        })}
                      </p>
                    </div>
                    <div class="text-right">
                      <span class={`inline-block px-3 py-1 text-xs font-medium rounded-full ${orderStatusColors[order.status]}`}>
                        {orderStatusMap[order.status]}
                      </span>
                      <p class="font-medium mt-2">{(order.total_amount || order.subtotal || 0).toFixed(2)}€</p>
                    </div>
                  </a>
                ))}
              </div>
            ) : (
              <div class="p-12 text-center">
                <svg class="w-16 h-16 mx-auto text-primary-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <p class="text-primary-500">Aún no tienes pedidos</p>
                <a href="/productos" class="btn btn-primary mt-4">
                  Explorar Productos
                </a>
              </div>
            )}
          </div>

          <!-- Acciones Rápidas -->
          <div class="grid md:grid-cols-2 gap-4">
            <a href="/cuenta/perfil" class="flex items-center gap-4 p-6 bg-white border border-primary-200 hover:border-primary-400 transition-colors">
              <div class="w-12 h-12 bg-primary-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </div>
              <div>
                <p class="font-medium">Editar Perfil</p>
                <p class="text-sm text-primary-500">Actualiza tus datos personales</p>
              </div>
            </a>
            <a href="/cuenta/direcciones" class="flex items-center gap-4 p-6 bg-white border border-primary-200 hover:border-primary-400 transition-colors">
              <div class="w-12 h-12 bg-primary-100 flex items-center justify-center">
                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
              </div>
              <div>
                <p class="font-medium">Mis Direcciones</p>
                <p class="text-sm text-primary-500">Gestiona tus direcciones de envío</p>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>
</PublicLayout>

<script>
  // Logout handler
  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
    // Mostrar estado de carga
    const btn = document.getElementById('logoutBtn') as HTMLButtonElement;
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'Cerrando sesión...';
    }
    
    // Usar la API de logout que maneja todo correctamente
    window.location.href = '/api/auth/logout?type=customer';
  });
</script>
