---
/**
 * Mi Cuenta - Dashboard del Cliente
 */
import AccountLayout from '@layouts/AccountLayout.astro';
import { supabase, supabaseAdmin } from '@lib/supabase';

export const prerender = false;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta');
}

// Verificar autenticación con el token
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  // Token inválido, limpiar cookies y redirigir
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta');
}

// Verificar que no sea admin
const { data: adminUser } = await supabaseAdmin
  .from('admin_users')
  .select('id, is_active')
  .eq('auth_user_id', user.id)
  .eq('is_active', true)
  .single();

if (adminUser) {
  // Es admin, no puede acceder a cuenta de cliente
  return Astro.redirect('/admin');
}

// Obtener perfil del cliente (buscar por auth_user_id; si no existe, intentar por email)
let customer = null;
{
  const { data: customerByAuth } = await supabase
    .from('customers')
    .select('*')
    .eq('auth_user_id', user.id)
    .maybeSingle();

  if (customerByAuth) {
    customer = customerByAuth;
  } else {
    const { data: customerByEmail } = await supabase
      .from('customers')
      .select('*')
      .eq('email', user.email)
      .maybeSingle();
    if (customerByEmail) customer = customerByEmail;
  }
}

// Buscar pedidos por customer_id y por customer_email (case-insensitive) y combinarlos
const lastWeekISO = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

let ordersById: any[] = [];
let ordersByEmail: any[] = [];

if (customer?.id) {
  const { data } = await supabase
    .from('orders')
    .select('*')
    .eq('customer_id', customer.id)
    .order('created_at', { ascending: false });
  ordersById = data || [];
}

if (user.email) {
  // usar ILIKE para evitar problemas de mayúsculas/minúsculas
  const { data } = await supabase
    .from('orders')
    .select('*')
    .ilike('customer_email', user.email)
    .order('created_at', { ascending: false });
  ordersByEmail = data || [];
}

// Combinar pedidos únicos por id
const ordersMap = new Map();
for (const o of [...ordersById, ...ordersByEmail]) {
  if (o && o.id) ordersMap.set(o.id, o);
}
const allOrders = Array.from(ordersMap.values());

// Pedidos recientes: últimos 7 días, ordenados desc y limitados a 5
const orders = allOrders
  .filter(o => new Date(o.created_at) >= new Date(lastWeekISO))
  .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
  .slice(0, 5);

const totalSpent = (allOrders || []).reduce((sum, order) => {
  return sum + (order.total_amount || order.subtotal || 0);
}, 0);

// Logs de depuración para inspeccionar en servidor si sigue saliendo 0
console.log('Account debug:', {
  userEmail: user.email,
  customerId: customer?.id || null,
  ordersFoundTotal: allOrders.length,
  ordersById: ordersById.length,
  ordersByEmail: ordersByEmail.length,
  recentOrders: orders.length
});

const orderStatusMap: Record<string, string> = {
  pending: 'Pendiente',
  confirmed: 'Confirmado',
  processing: 'En proceso',
  shipped: 'Enviado',
  delivered: 'Entregado',
  cancelled: 'Cancelado',
  refunded: 'Reembolsado'
};

const orderStatusColors: Record<string, string> = {
  pending: 'bg-yellow-100 text-yellow-800',
  confirmed: 'bg-blue-100 text-blue-800',
  processing: 'bg-indigo-100 text-indigo-800',
  shipped: 'bg-purple-100 text-purple-800',
  delivered: 'bg-green-100 text-green-800',
  cancelled: 'bg-red-100 text-red-800',
  refunded: 'bg-gray-100 text-gray-800'
};

function formatPrice(price: number) {
  return price.toFixed(2) + '€';
}
---

<AccountLayout title="Resumen">
  <div class="space-y-6">
    <!-- Stats Cards -->
    <div class="grid md:grid-cols-3 gap-6">
      <div class="bg-white rounded-lg border border-primary-200 p-6">
        <p class="text-primary-500 text-sm font-medium mb-2">PEDIDOS</p>
        <p class="text-3xl font-bold text-primary-900">{allOrders?.length || 0}</p>
      </div>
      <div class="bg-white rounded-lg border border-primary-200 p-6">
        <p class="text-primary-500 text-sm font-medium mb-2">TOTAL GASTADO</p>
        <p class="text-3xl font-bold text-primary-900">{formatPrice(totalSpent)}</p>
      </div>
      <div class="bg-white rounded-lg border border-primary-200 p-6">
        <p class="text-primary-500 text-sm font-medium mb-2">MIEMBRO DESDE</p>
        <p class="text-3xl font-bold text-primary-900">{new Date(user.created_at!).toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }).replace(' de ', ' ')}</p>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="bg-white rounded-lg border border-primary-200 p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-primary-900">Pedidos Recientes</h2>
        <a href="/cuenta/pedidos" class="text-sm text-primary-600 hover:text-primary-900">Ver todos →</a>
      </div>
      {orders && orders.length > 0 ? (
        <div class="space-y-4">
          {orders.slice(0, 3).map((order: any) => (
            <a href={`/cuenta/pedidos/${order.order_number}`} class="block p-4 border border-primary-100 rounded-lg hover:border-primary-300 hover:bg-primary-50 transition-colors">
              <div class="flex items-center justify-between">
                <div>
                  <p class="font-semibold text-primary-900">Pedido #{order.order_number}</p>
                  <p class="text-sm text-primary-500">{new Date(order.created_at).toLocaleDateString('es-ES')}</p>
                </div>
                <div class="text-right">
                  <p class="font-semibold">{formatPrice(order.total_amount)}</p>
                  <span class={`text-xs font-semibold px-2 py-1 rounded ${orderStatusColors[order.status] || 'bg-gray-100 text-gray-800'}`}>
                    {orderStatusMap[order.status] || order.status}
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <svg class="w-16 h-16 text-primary-200 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
          </svg>
          <p class="text-primary-500 mb-4">Aún no tienes pedidos</p>
          <a href="/productos" class="text-primary-600 hover:text-primary-900 font-medium">Explorar Productos →</a>
        </div>
      )}
    </div>

    <!-- Quick Actions -->
    <div class="grid md:grid-cols-2 gap-6">
      <a href="/cuenta/perfil" class="bg-white rounded-lg border border-primary-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-start gap-4">
          <svg class="w-6 h-6 text-primary-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <div>
            <h3 class="font-bold text-primary-900">Editar Perfil</h3>
            <p class="text-sm text-primary-500">Actualiza tus datos personales</p>
          </div>
        </div>
      </a>
      <a href="/cuenta/direcciones" class="bg-white rounded-lg border border-primary-200 p-6 hover:shadow-lg transition-shadow">
        <div class="flex items-start gap-4">
          <svg class="w-6 h-6 text-primary-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <div>
            <h3 class="font-bold text-primary-900">Mis Direcciones</h3>
            <p class="text-sm text-primary-500">Gestiona tus direcciones de envío</p>
          </div>
        </div>
      </a>
    </div>
  </div>
</AccountLayout>
