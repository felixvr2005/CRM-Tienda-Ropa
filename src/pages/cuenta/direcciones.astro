---
import AccountLayout from '@layouts/AccountLayout.astro';
import { supabase } from '@lib/supabase';

export const prerender = false;

// Obtener token de cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/cuenta/login?redirect=/cuenta/direcciones');
}

// Verificar autenticación con el token
const { data: { user }, error: authError } = await supabase.auth.getUser(accessToken);

if (authError || !user) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/cuenta/login?redirect=/cuenta/direcciones');
}

// Manejar acciones POST
let successMessage = '';
let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    // Aceptar tanto FormData como JSON
    let data: Record<string, any> = {};
    const contentType = Astro.request.headers.get('content-type');
    
    if (contentType?.includes('application/json')) {
      data = await Astro.request.json();
    } else {
      const formData = await Astro.request.formData();
      for (const [key, value] of formData.entries()) {
        data[key] = value;
      }
    }

    const action = data.action;

    // Obtener direcciones actuales AHORA (no antes)
    const { data: currentCustomer } = await supabase
      .from('customers')
      .select('id, addresses')
      .eq('auth_user_id', user.id)
      .single();
    
    let currentAddresses = currentCustomer?.addresses || [];

    if (action === 'add' || action === 'edit') {
      const addressData = {
        id: action === 'edit' ? data.addressId : crypto.randomUUID(),
        name: data.name,
        street: data.street,
        street2: data.street2 || '',
        city: data.city,
        province: data.province,
        postal_code: data.postalCode,
        country: data.country || 'España',
        phone: data.phone || '',
        is_default: data.isDefault === 'on' || data.isDefault === true
      };

      let newAddresses = [...currentAddresses];
      
      if (action === 'edit') {
        const index = newAddresses.findIndex((a: any) => a.id === addressData.id);
        if (index !== -1) {
          newAddresses[index] = addressData;
        }
      } else {
        newAddresses.push(addressData);
      }

      // Si es default, quitar default de las demás
      if (addressData.is_default) {
        newAddresses = newAddresses.map((a: any) => ({
          ...a,
          is_default: a.id === addressData.id
        }));
      }

      const { error } = await supabase
        .from('customers')
        .update({ addresses: newAddresses })
        .eq('auth_user_id', user.id);

      if (error) throw error;
      successMessage = action === 'edit' ? 'Dirección actualizada correctamente' : 'Dirección añadida correctamente';
    }

    if (action === 'delete') {
      const addressId = data.addressId;
      const newAddresses = currentAddresses.filter((a: any) => a.id !== addressId);

      const { error } = await supabase
        .from('customers')
        .update({ addresses: newAddresses })
        .eq('auth_user_id', user.id);

      if (error) throw error;
      successMessage = 'Dirección eliminada correctamente';
    }

    if (action === 'setDefault') {
      const addressId = data.addressId;
      const newAddresses = currentAddresses.map((a: any) => ({
        ...a,
        is_default: a.id === addressId
      }));

      const { error } = await supabase
        .from('customers')
        .update({ addresses: newAddresses })
        .eq('auth_user_id', user.id);

      if (error) throw error;
      successMessage = 'Dirección predeterminada actualizada';
    }
  } catch (err: any) {
    console.error('Error en direcciones:', err);
    errorMessage = err.message || 'Error al procesar la solicitud';
  }
}

// Obtener cliente y direcciones actualizadas
const { data: customer } = await supabase
  .from('customers')
  .select('id, addresses')
  .eq('auth_user_id', user.id)
  .single();

const currentAddresses = customer?.addresses || [];

// Provincias de España
const provinces = [
  'A Coruña', 'Álava', 'Albacete', 'Alicante', 'Almería', 'Asturias', 'Ávila',
  'Badajoz', 'Barcelona', 'Burgos', 'Cáceres', 'Cádiz', 'Cantabria', 'Castellón',
  'Ciudad Real', 'Córdoba', 'Cuenca', 'Girona', 'Granada', 'Guadalajara',
  'Guipúzcoa', 'Huelva', 'Huesca', 'Illes Balears', 'Jaén', 'La Rioja',
  'Las Palmas', 'León', 'Lleida', 'Lugo', 'Madrid', 'Málaga', 'Murcia',
  'Navarra', 'Ourense', 'Palencia', 'Pontevedra', 'Salamanca', 'Santa Cruz de Tenerife',
  'Segovia', 'Sevilla', 'Soria', 'Tarragona', 'Teruel', 'Toledo', 'Valencia',
  'Valladolid', 'Vizcaya', 'Zamora', 'Zaragoza', 'Ceuta', 'Melilla'
];
---

<AccountLayout title="Mis Direcciones">
  <div class="space-y-6">
    {successMessage && (
      <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
        {successMessage}
      </div>
    )}
    {errorMessage && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
        {errorMessage}
      </div>
    )}

    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-primary-900">Mis Direcciones</h1>
      <button
        id="addAddressBtn"
        class="px-4 py-2 bg-primary-900 text-white rounded hover:bg-primary-800 transition-colors"
      >
        + Añadir Dirección
      </button>
    </div>

    <!-- Addresses List -->
    {addresses && addresses.length > 0 ? (
      <div class="space-y-4">
        {addresses.map((address: any) => (
          <div class="bg-white border border-primary-200 rounded-lg p-6">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="font-semibold text-primary-900">{address.name}</h3>
                {address.is_default && (
                  <span class="text-xs bg-primary-100 text-primary-700 px-2 py-1 rounded">Dirección principal</span>
                )}
              </div>
              <div class="flex gap-2">
                <button
                  class="edit-address-btn text-sm text-primary-600 hover:text-primary-900"
                  data-address-id={address.id}
                >
                  Editar
                </button>
                <button
                  class="delete-address-btn text-sm text-red-600 hover:text-red-900"
                  data-address-id={address.id}
                >
                  Eliminar
                </button>
              </div>
            </div>
            <p class="text-sm text-primary-700">
              {address.street} {address.street2 && `, ${address.street2}`}
            </p>
            <p class="text-sm text-primary-700">
              {address.postal_code} {address.city}, {address.province}
            </p>
            <p class="text-sm text-primary-700">{address.country}</p>
            {address.phone && (
              <p class="text-sm text-primary-700">{address.phone}</p>
            )}
          </div>
        ))}
      </div>
    ) : (
      <div class="bg-white border border-primary-200 rounded-lg p-12 text-center">
        <p class="text-primary-500 mb-6">No tienes direcciones guardadas</p>
        <button
          id="addAddressBtn2"
          class="px-4 py-2 bg-primary-900 text-white rounded hover:bg-primary-800 transition-colors"
        >
          Añadir Dirección
        </button>
      </div>
    )}
  </div>
</AccountLayout>

<script>
  // Handle delete
  document.querySelectorAll('.delete-address-btn').forEach((btn) => {
    btn.addEventListener('click', async () => {
      if (!confirm('¿Eliminar esta dirección?')) return;
      const addressId = (btn as HTMLElement).dataset.addressId;
      const response = await fetch('/src/pages/cuenta/direcciones.astro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', addressId })
      });
      if (response.ok) window.location.reload();
    });
  });
</script>
