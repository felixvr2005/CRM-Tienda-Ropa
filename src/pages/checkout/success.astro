---
/**
 * Checkout Success Page - SSR
 * Procesa el pedido cuando el usuario regresa de Stripe
 */
import PublicLayout from '@layouts/PublicLayout.astro';
import Stripe from 'stripe';
import { supabaseAdmin } from '@lib/supabase';
import { sendCustomerEmail } from '@lib/email';
import type { CustomerEmailData } from '@lib/email';
import { ensureEnv } from '@lib/ensureEnv';

export const prerender = false;

// Aseguramos claves necesarias para el flujo de éxito de pago
ensureEnv(['STRIPE_SECRET_KEY']);

const stripe = new Stripe(import.meta.env.STRIPE_SECRET_KEY);

// Get session_id from URL
const sessionId = Astro.url.searchParams.get('session_id');

let order = null;
let orderError = '';

if (sessionId) {
  try {
    logger.info('Processing checkout success', { sessionId });
    
    // Verificar si ya existe un pedido con esta sesión
    const { data: existingOrder } = await supabaseAdmin
      .from('orders')
      .select('*')
      .eq('stripe_checkout_session_id', sessionId)
      .single();

    if (existingOrder) {
      logger.info('Order already exists for session', { orderNumber: existingOrder.order_number });
      order = existingOrder;
    } else {
      // Obtener la sesión de Stripe con detalles expandidos
      const session = await stripe.checkout.sessions.retrieve(sessionId, {
        expand: ['line_items']
      });
      
      logger.debug('Stripe session retrieved', { payment_status: session.payment_status, customer_email: session.customer_email });
      logger.silly?.('Stripe session metadata (debug)', session.metadata);
      logger.silly?.('Stripe shipping details (debug)', session.shipping_details);
      
      if (session.payment_status === 'paid') {
        // Obtener metadata
        const metadata = session.metadata || {};
        const items = metadata.items ? JSON.parse(metadata.items) : [];
        
        logger.debug('Items from metadata (parsed)', { itemsCount: items.length });

        // Datos del cliente desde Stripe (capturados en el checkout)
        const email = session.customer_email || session.customer_details?.email || metadata.email || 'felixvr2005@gmail.com';
        const phone = session.customer_details?.phone || metadata.phone || '';
        const shippingDetails = session.shipping_details;
        
        // Construir dirección de envío
        const shippingAddress = shippingDetails ? {
          name: shippingDetails.name || '',
          address: shippingDetails.address?.line1 || '',
          city: shippingDetails.address?.city || '',
          state: shippingDetails.address?.state || '',
          postal_code: shippingDetails.address?.postal_code || '',
          country: shippingDetails.address?.country || 'ES'
        } : null;

        if (items.length > 0) {
          // Generar número de pedido secuencial
          const { data: lastOrder } = await supabaseAdmin
            .from('orders')
            .select('order_number')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

          let nextNumber = 1;
          if (lastOrder && lastOrder.order_number) {
            const match = lastOrder.order_number.match(/(\d+)$/);
            if (match) {
              nextNumber = parseInt(match[1], 10) + 1;
            }
          }
          const orderNumber = nextNumber.toString().padStart(6, '0');
          logger.info('Generated order number', { orderNumber });

          // Calcular totales
          const subtotal = items.reduce((acc: number, item: any) => acc + (item.price * item.quantity), 0);
          const totalAmount = (session.amount_total || 0) / 100;
          const shippingCost = totalAmount - subtotal; // Calcular costo de envío por diferencia

          // Buscar customer
          let customerId = null;
          if (email) {
            const { data: existingCustomer } = await supabaseAdmin
              .from('customers')
              .select('id')
              .eq('email', email)
              .single();
            if (existingCustomer) {
              customerId = existingCustomer.id;
            }
          }

          // Crear el pedido (con columnas correctas según complete-schema.sql)
          const orderData = {
            order_number: orderNumber,
            customer_id: customerId,
            customer_email: email,
            customer_name: shippingAddress?.name || '',
            customer_phone: phone,
            status: 'pending',
            payment_status: 'paid',
            payment_method: 'stripe',
            stripe_checkout_session_id: sessionId,
            stripe_payment_intent_id: session.payment_intent as string,
            subtotal: subtotal,
            shipping_cost: shippingCost > 0 ? shippingCost : 0,
            discount_amount: 0,
            total_amount: totalAmount,
            shipping_address: shippingAddress
          };
          
          logger.info('Creating order (inserting into DB)', { orderDataSummary: { order_number: orderData.order_number, subtotal: orderData.subtotal, total: orderData.total_amount } });
          
          const { data: newOrder, error: createError } = await supabaseAdmin
            .from('orders')
            .insert(orderData as any)
            .select()
            .single();

          if (createError) {
            logger.error('Error creating order', { error: createError });
            orderError = `Error al crear el pedido: ${createError.message}`;
          } else {
            order = newOrder;
            logger.info('Order created successfully', { orderNumber: (order as any).order_number });

            // ✉️ Enviar email de confirmación al cliente
            if (email) {
              try {
                logger.info('Preparando email de confirmación', { to: email });
                
                // Construir datos del email
                const emailData: CustomerEmailData = {
                  customer_name: shippingAddress?.name || 'Cliente',
                  order_number: orderNumber,
                  order_date: new Date().toLocaleDateString('es-ES'),
                  order_status: 'Pendiente',
                  payment_method: 'Tarjeta de Crédito (Stripe)',
                  products: items.map((item: any) => ({
                    product_name: item.name || 'Producto',
                    product_sku: item.sku || 'N/A',
                    quantity: item.quantity,
                    unit: 'unidad',
                    unit_price: item.price,
                    total_price: item.price * item.quantity
                  })),
                  subtotal: subtotal,
                  tax_rate: 0,
                  tax_amount: 0,
                  shipping_cost: shippingCost > 0 ? shippingCost : 0,
                  discount_applied: false,
                  discount_code: undefined,
                  discount_amount: 0,
                  total_amount: totalAmount,
                  active_offers: [],
                  recommendations: [],
                  promo_code_available: true,
                  promo_code: 'WELCOME2026',
                  promo_description: 'Código de bienvenida: 10% en tu próxima compra',
                  track_order_url: `${Astro.site}/cuenta/pedidos/${orderNumber}`,
                  continue_shopping_url: `${Astro.site}/productos`,
                  customer_address: shippingAddress ? `${shippingAddress.address}, ${shippingAddress.city} (${shippingAddress.postal_code})` : '',
                  support_email: 'soporte@tiendamoda.com',
                  facebook_url: 'https://facebook.com/tiendamoda',
                  instagram_url: 'https://instagram.com/tiendamoda',
                  twitter_url: 'https://twitter.com/tiendamoda',
                  company_name: 'Tienda de Moda Premium',
                  current_year: new Date().getFullYear()
                };
                
                // Enviar email
                const emailResult = await sendCustomerEmail(email, emailData);
                logger.info('Email enviado al cliente', { messageId: emailResult.messageId });
                
              } catch (emailError) {
                logger.error('Error enviando email de confirmación', { error: String(emailError) });
                // No detener el flujo si falla el email
              }
            }

            // Crear items del pedido y descontar stock
            for (const item of items) {
              logger.debug('Processing item for order creation', { variantId: item.variantId, quantity: item.quantity });
              
              const { data: variant, error: variantError } = await supabaseAdmin
                .from('product_variants')
                .select(`
                  id, color, size, price_modifier, stock,
                  product:products(id, name, price, images)
                `)
                .eq('id', item.variantId)
                .single();

              if (variantError) {
                logger.error('Error fetching variant for order item', { error: variantError });
                continue;
              }

              if (variant) {
                const variantData = variant as any;
                
                // Crear order item (usando columnas correctas del esquema)
                const orderItemData = {
                  order_id: (order as any).id,
                  product_id: variantData.product?.id || item.productId,
                  variant_id: item.variantId,
                  product_name: item.name || variantData.product?.name || 'Producto',
                  size: variantData.size || '',
                  color: variantData.color || '',
                  quantity: item.quantity,
                  unit_price: item.price,
                  discount_percentage: 0,
                  total_price: item.price * item.quantity
                };
                
                logger.debug('Creating order item', { productId: orderItemData.product_id, quantity: orderItemData.quantity });
                
                const { error: itemError } = await supabaseAdmin
                  .from('order_items')
                  .insert(orderItemData as any);
                  
                if (itemError) {
                  logger.error('Error creating order item', { error: itemError });
                }

                // El stock ya fue descontado cuando se añadió al carrito (reserva temporal)
                // No es necesario descontarlo de nuevo aquí
                logger.info('Stock previamente reservado para variant', { variantId: item.variantId, quantity: item.quantity });
              }
            }
          }
        } else {
          logger.warn('No items found in metadata for session', { sessionId });
          orderError = 'No se encontraron productos en la sesión de pago';
        }
      } else {
        logger.debug('Payment not completed yet', { status: session.payment_status });
        orderError = 'El pago aún no ha sido confirmado';
      }
    }
  } catch (err: any) {
    logger.error('Error processing checkout', { error: String(err) });
    orderError = err.message;
  }
}
---

<PublicLayout title="Pedido confirmado" showPromoBar={false}>
  <div class="max-w-2xl mx-auto px-4 py-20 text-center">
    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-8">
      <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    
    <h1 class="font-display text-4xl mb-4">¡Gracias por tu pedido!</h1>
    
    {order && (
      <div class="bg-green-50 border border-green-200 p-4 mb-6 text-left">
        <p class="text-green-800 font-medium">Pedido #{(order as any).order_number}</p>
        <p class="text-green-700 text-sm">Tu pedido ha sido registrado correctamente.</p>
      </div>
    )}
    
    <p class="text-primary-600 text-lg mb-8">
      Tu pedido ha sido confirmado y está siendo procesado.
      Recibirás un email de confirmación en breve.
    </p>
    
    {sessionId && !order && (
      <p class="text-sm text-primary-500 mb-8">
        ID de transacción: <span class="font-mono">{sessionId}</span>
      </p>
    )}
    
    {orderError && (
      <div class="bg-yellow-50 border border-yellow-200 p-4 mb-6 text-left">
        <p class="text-yellow-800 text-sm">{orderError}</p>
      </div>
    )}
    
    <div class="bg-primary-50 p-6 text-left mb-8">
      <h2 class="font-medium mb-4">¿Qué pasa ahora?</h2>
      <ul class="space-y-3 text-sm text-primary-600">
        <li class="flex items-start gap-3">
          <span class="w-6 h-6 bg-primary-900 text-white rounded-full flex items-center justify-center flex-shrink-0 text-xs">1</span>
          <span>Recibirás un email de confirmación con los detalles de tu pedido.</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="w-6 h-6 bg-primary-900 text-white rounded-full flex items-center justify-center flex-shrink-0 text-xs">2</span>
          <span>Prepararemos tu pedido con el máximo cuidado.</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="w-6 h-6 bg-primary-900 text-white rounded-full flex items-center justify-center flex-shrink-0 text-xs">3</span>
          <span>Te enviaremos un email con el número de seguimiento cuando tu pedido sea enviado.</span>
        </li>
      </ul>
    </div>
    
    <div class="flex flex-col sm:flex-row gap-4 justify-center">
      <a 
        href="/productos" 
        class="bg-primary-900 text-white px-8 py-3 text-sm tracking-widest uppercase hover:bg-primary-800 transition-colors"
      >
        Seguir comprando
      </a>
      <a 
        href="/" 
        class="border border-primary-300 px-8 py-3 text-sm tracking-widest uppercase hover:bg-primary-50 transition-colors"
      >
        Volver al inicio
      </a>
    </div>
  </div>
  
  <script>
    // Clear cart after successful checkout (NO liberar stock, ya se compró)
    localStorage.removeItem('fashionstore_cart');
    localStorage.removeItem('fashionstore_cart_expires');
    localStorage.removeItem('fashionstore_guest_session');
    
    // Dispatch event to update cart UI
    window.dispatchEvent(new CustomEvent('cart:cleared'));
  </script>
</PublicLayout>
